<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>MISTJ</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" name="format-detection" content="telephone=no"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon.ico.png"><link rel="preload" href="/_nuxt/js/runtime.1631670569310.js" as="script"><link rel="preload" href="/_nuxt/js/commons/app.1631670569310.js" as="script"><link rel="preload" href="/_nuxt/js/vendors/app.1631670569310.js" as="script"><link rel="preload" href="/_nuxt/js/app.1631670569310.js" as="script"><link rel="preload" href="/_nuxt/js/pages/wiki.1631670569310.js" as="script"><link rel="preload" href="/_nuxt/js/pages/wiki/content/_slug.1631670569310.js" as="script"><style data-vue-ssr-id="5764bbd8:0 1a114e69:0 5fd7ed67:0 21344d92:0 387be0d0:0 fa7ff0ca:0 1e7bd454:0 36807403:0">.svg-inline--fa,svg:not(:root).svg-inline--fa{overflow:visible}.svg-inline--fa{display:inline-block;font-size:inherit;height:1em;vertical-align:-.125em}.svg-inline--fa.fa-lg{vertical-align:-.225em}.svg-inline--fa.fa-w-1{width:.0625em}.svg-inline--fa.fa-w-2{width:.125em}.svg-inline--fa.fa-w-3{width:.1875em}.svg-inline--fa.fa-w-4{width:.25em}.svg-inline--fa.fa-w-5{width:.3125em}.svg-inline--fa.fa-w-6{width:.375em}.svg-inline--fa.fa-w-7{width:.4375em}.svg-inline--fa.fa-w-8{width:.5em}.svg-inline--fa.fa-w-9{width:.5625em}.svg-inline--fa.fa-w-10{width:.625em}.svg-inline--fa.fa-w-11{width:.6875em}.svg-inline--fa.fa-w-12{width:.75em}.svg-inline--fa.fa-w-13{width:.8125em}.svg-inline--fa.fa-w-14{width:.875em}.svg-inline--fa.fa-w-15{width:.9375em}.svg-inline--fa.fa-w-16{width:1em}.svg-inline--fa.fa-w-17{width:1.0625em}.svg-inline--fa.fa-w-18{width:1.125em}.svg-inline--fa.fa-w-19{width:1.1875em}.svg-inline--fa.fa-w-20{width:1.25em}.svg-inline--fa.fa-pull-left{margin-right:.3em;width:auto}.svg-inline--fa.fa-pull-right{margin-left:.3em;width:auto}.svg-inline--fa.fa-border{height:1.5em}.svg-inline--fa.fa-li{width:2em}.svg-inline--fa.fa-fw{width:1.25em}.fa-layers svg.svg-inline--fa{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.fa-layers{display:inline-block;height:1em;position:relative;text-align:center;vertical-align:-.125em;width:1em}.fa-layers svg.svg-inline--fa{transform-origin:center center}.fa-layers-counter,.fa-layers-text{display:inline-block;position:absolute;text-align:center}.fa-layers-text{left:50%;top:50%;transform:translate(-50%,-50%);transform-origin:center center}.fa-layers-counter{background-color:#ff253a;border-radius:1em;box-sizing:border-box;color:#fff;height:1.5em;line-height:1;max-width:5em;min-width:1.5em;overflow:hidden;padding:.25em;right:0;text-overflow:ellipsis;top:0;transform:scale(.25);transform-origin:top right}.fa-layers-bottom-right{bottom:0;right:0;top:auto;transform:scale(.25);transform-origin:bottom right}.fa-layers-bottom-left{bottom:0;left:0;right:auto;top:auto;transform:scale(.25);transform-origin:bottom left}.fa-layers-top-right{right:0;top:0;transform:scale(.25);transform-origin:top right}.fa-layers-top-left{left:0;right:auto;top:0;transform:scale(.25);transform-origin:top left}.fa-lg{font-size:1.33333em;line-height:.75em;vertical-align:-.0667em}.fa-xs{font-size:.75em}.fa-sm{font-size:.875em}.fa-1x{font-size:1em}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-6x{font-size:6em}.fa-7x{font-size:7em}.fa-8x{font-size:8em}.fa-9x{font-size:9em}.fa-10x{font-size:10em}.fa-fw{text-align:center;width:1.25em}.fa-ul{list-style-type:none;margin-left:2.5em;padding-left:0}.fa-ul>li{position:relative}.fa-li{left:-2em;position:absolute;text-align:center;width:2em;line-height:inherit}.fa-border{border:.08em solid #eee;border-radius:.1em;padding:.2em .25em .15em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left,.fab.fa-pull-left,.fal.fa-pull-left,.far.fa-pull-left,.fas.fa-pull-left{margin-right:.3em}.fa.fa-pull-right,.fab.fa-pull-right,.fal.fa-pull-right,.far.fa-pull-right,.fas.fa-pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s linear infinite;animation:fa-spin 2s linear infinite}.fa-pulse{-webkit-animation:fa-spin 1s steps(8) infinite;animation:fa-spin 1s steps(8) infinite}@-webkit-keyframes fa-spin{0%{transform:rotate(0)}to{transform:rotate(1turn)}}@keyframes fa-spin{0%{transform:rotate(0)}to{transform:rotate(1turn)}}.fa-rotate-90{transform:rotate(90deg)}.fa-rotate-180{transform:rotate(180deg)}.fa-rotate-270{transform:rotate(270deg)}.fa-flip-horizontal{transform:scaleX(-1)}.fa-flip-vertical{transform:scaleY(-1)}.fa-flip-both,.fa-flip-horizontal.fa-flip-vertical{transform:scale(-1)}:root .fa-flip-both,:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-rotate-90{filter:none}.fa-stack{display:inline-block;height:2em;position:relative;width:2.5em}.fa-stack-1x,.fa-stack-2x{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.svg-inline--fa.fa-stack-1x{height:1em;width:1.25em}.svg-inline--fa.fa-stack-2x{height:2em;width:2.5em}.fa-inverse{color:#fff}.sr-only{border:0;clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.sr-only-focusable:active,.sr-only-focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}.svg-inline--fa .fa-primary{fill:currentColor;fill:var(--fa-primary-color,currentColor);opacity:1;opacity:var(--fa-primary-opacity,1)}.svg-inline--fa .fa-secondary{fill:currentColor;fill:var(--fa-secondary-color,currentColor)}.svg-inline--fa .fa-secondary,.svg-inline--fa.fa-swap-opacity .fa-primary{opacity:.4;opacity:var(--fa-secondary-opacity,.4)}.svg-inline--fa.fa-swap-opacity .fa-secondary{opacity:1;opacity:var(--fa-primary-opacity,1)}.svg-inline--fa mask .fa-primary,.svg-inline--fa mask .fa-secondary{fill:#000}.fad.fa-inverse{color:#fff}*,:after,:before{box-sizing:inherit}html{box-sizing:border-box;font-size:62.5%}body{color:#333;margin:0;background-color:#fafafa;font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;font-size:1.6em;font-weight:300;line-height:1.8em}@media only screen and (max-width:768px){body{font-size:1.6em;line-height:1.6em}}a{font-weight:300;color:#1565c0;text-decoration:none}a:focus,a:hover{text-decoration:underline}p{margin:2rem 0}h1,h2,h3,h4,h5,h6{font-family:Lato,Helvetica,sans-serif;font-weight:700;color:#000;margin:6.4rem 0 3.2rem}h1{font-size:3.2rem;line-height:3.6rem}@media only screen and (max-width:768px){h1{font-size:3rem;line-height:3.4rem}}h2{font-size:2.8rem;line-height:3.2rem}@media only screen and (max-width:768px){h2{font-size:2.6rem;line-height:3rem}}h3{font-size:2.4rem;line-height:2.8rem}@media only screen and (max-width:768px){h3{font-size:2.2rem;line-height:2.6rem}}h4{font-size:2.2rem;line-height:2.6rem}@media only screen and (max-width:768px){h4{font-size:2rem;line-height:2.4rem}}h5{font-size:2rem;line-height:2.4rem}@media only screen and (max-width:768px){h5{font-size:1.8rem;line-height:2.2rem}}h6{font-size:1.8rem;line-height:2.2rem}@media only screen and (max-width:768px){h6{font-size:1.6rem;line-height:2rem}}b,strong{font-weight:700}.highlight>div,.highlight>pre{margin:0 0 2rem;padding:1rem;border-radius:1rem}pre{display:block;font-family:"Source Code Pro","Lucida Console",monospace;font-size:1.6rem;font-weight:400;line-height:2.6rem;overflow-x:auto;margin:0}pre code{display:inline-block;background-color:inherit;color:inherit}code{font-family:"Source Code Pro","Lucida Console",monospace;font-weight:400;background-color:#e0e0e0;color:#333}blockquote{border-left:2px solid #e0e0e0;padding-left:2rem;line-height:2.2rem;font-weight:400;font-style:italic}td,th{padding:1.6rem}table{border-collapse:collapse}table td,table th{border:2px solid #000}table tr:first-child th{border-top:0}table tr:last-child td{border-bottom:0}table tr td:first-child,table tr th:first-child{border-left:0}table tr td:last-child,table tr th:last-child{border-right:0}img{max-width:100%}figure{text-align:center}.wrapper{display:flex;flex-direction:column;min-height:100vh;width:100%}.container{margin:0 auto;max-width:90rem;width:100%;padding-left:2rem;padding-right:2rem}.fas{font-weight:700}.float-right{float:right}.float-left{float:left}.fab{font-weight:400}.fas{font-weight:900}img.emoji{height:1em;width:1em;margin:0 .05em 0 .1em;vertical-align:-.1em}#tap-to-top{display:none!important;z-index:90;position:fixed;bottom:2em;right:2em;top:auto;left:auto;color:#fafafa;padding:10px 16px;border:1px solid #fafafa;background-color:#333;transition:color .2s ease,border-color .2s ease,background .2s ease,opacity .2s ease}.toc-fixed #tap-to-top{display:inline-block!important}.flex{display:flex}.flex-y-center{display:flex;justify-content:center}.flex-align-center{display:flex;align-items:center}.content{flex:1;display:flex;margin-top:1.6rem;margin-bottom:3.2rem}.content article{width:100%;word-break:break-word;font-size:25.6px;font-size:1.6rem;line-height:1.6}.content article h1,.content article h1 *,.content article h2,.content article h2 *,.content article h3,.content article h3 *,.content article h4,.content article h4 *,.content article h5,.content article h5 *,.content article h6,.content article h6 *{word-break:break-all}.content article header{margin-top:6.4rem;margin-bottom:3.2rem}.content article header h1{font-size:4.2rem;line-height:4.6rem;margin:0}@media only screen and (max-width:768px){.content article header h1{font-size:4rem;line-height:4.4rem}}.content article footer{margin-top:4rem}.content article footer .see-also,.content article footer .see-also h3{margin:3.2rem 0}.content article div,.content article p{-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.content article a:hover{background:0 0}.content article img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}.content article blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}.content article blockquote:before{position:absolute}.content article blockquote *{margin:0;font-size:inherit}.content article table{margin:0 0 1.2em;border:none}.content article table td,.content article table th{border:none}.content article ul{margin:0 0 1.2em;padding:0;list-style:disc}.content article ul li{font-size:inherit;list-style:disc}.content article ul li *{margin:0;text-align:left;text-align:initial}.content article ol{list-style:decimal;margin:0;padding:0}.content article ol li{list-style:decimal}.content article ol li *{margin:0;text-align:left;text-align:initial}.content article li ol,.content article li ul{margin-left:2em}.content article li ul{list-style:circle}.content article .article-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.content article .article-center-small{display:inline-flex}.content article .article-center-small img{margin:0;padding:0;border:0;box-shadow:none}.content article .article-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}.content article h1,.content article h2,.content article h3,.content article h4,.content article h5,.content article h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#333}.content article h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}.content article h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}.content article h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}.content article h4{font-size:32px;font-size:2rem}.content article h5,.content article h6{font-size:25.6px;font-size:1.6rem}.content article h6{color:#777}.content article ol,.content article ul{list-style-type:disc;padding:0 0 0 2em}.content article ol ol,.content article ul ol{list-style-type:lower-roman}.content article ol ol ol,.content article ol ul ol,.content article ul ol ol,.content article ul ul ol{list-style-type:lower-alpha}.content article table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}.content article table tr{background-color:#fff;border-top:1px solid #ccc}.content article table th{font-weight:700}.content article table td,.content article table th{padding:6px 13px;border:1px solid #ddd}.content article blockquote{border-left:4px solid #ddd}.content article strong{font-weight:600!important;color:#000!important}.content article a:active,.content article a:focus,.content article a:hover{color:#4183c4;text-decoration:underline}.content article pre code,.content article pre code *{font-size:15px}.content article li code,.content article p code{border-radius:3px;font-size:90%;line-height:1.2;padding:.1rem .2rem;color:#d73e48;background:#fcf2f2}.content article h1,.content article h2{padding-top:1.7rem;padding-bottom:1.2rem;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAABCAYAAACsXeyTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQIHWNIS0sr/v//PwMMDzY+ADqMahlW4J91AAAAAElFTkSuQmCC) 0 100% repeat-x}.content article,.content article *,.content article div,.content article p{font-weight:400;line-height:1.8}.content .co-width-2{width:16.7%}.content .co-width-10{width:83.3%}.content .co-width-12{width:100%}.content .container{max-width:90rem}.content #body-wrapper{display:flex}.content .post .post-title{margin-bottom:.75em}.content .post .post-meta .fa{text-align:center;width:1.6rem;margin-left:0;margin-right:.5rem}.content .post .post-meta .date .posted-on,.content .post .post-meta .date .reading-time{margin-left:0;margin-right:1.5rem}@media only screen and (max-width:840px){.content #toc-slider{display:none}.content .body-content{width:100%}}.content figure{margin:0;padding:0}.content figcaption p{text-align:center;font-style:italic;font-size:1.6rem;margin:0}.avatar img{width:20rem;height:auto;border-radius:50%}@media only screen and (max-width:768px){.avatar img{width:10rem}}.list ul{margin:3.2rem 0;list-style:none;padding:0}.list ul li{font-size:1.8rem}@media only screen and (max-width:768px){.list ul li{margin:1.6rem 0}}.list ul li .date{display:inline-block;flex:1;width:20rem;text-align:right;margin-right:3rem}@media only screen and (max-width:768px){.list ul li .date{display:block;text-align:left}}.list ul li .title{font-size:1.8rem;flex:2;color:#333;font-family:Lato,Helvetica,sans-serif;font-weight:700}.list ul li .title:focus,.list ul li .title:hover{color:#1565c0}@media only screen and (min-width:768.1px){.list ul:not(.pagination) li{display:flex}}.centered{display:flex;align-items:center;justify-content:center}.centered .about{text-align:center}.centered .about h1{margin-top:2rem;margin-bottom:.5rem}.centered .about h2{margin-top:1rem;margin-bottom:.5rem;font-size:2.4rem}@media only screen and (max-width:768px){.centered .about h2{font-size:2rem}}.centered .about ul{list-style:none;margin:3rem 0 1rem;padding:0}.centered .about ul li{display:inline-block;position:relative}.centered .about ul li a{color:#333;text-transform:uppercase;margin-left:1rem;margin-right:1rem;font-size:1.6rem}.centered .about ul li a:focus,.centered .about ul li a:hover{color:#1565c0}@media only screen and (max-width:768px){.centered .about ul li a{font-size:1.4rem}}.centered .about ul li a i{font-size:3.2rem}.centered .error{text-align:center}.centered .error h1{margin-top:2rem;margin-bottom:.5rem;font-size:4.6rem}@media only screen and (max-width:768px){.centered .error h1{font-size:3.2rem}}.centered .error h2{margin-top:2rem;margin-bottom:3.2rem;font-size:3.2rem}@media only screen and (max-width:768px){.centered .error h2{font-size:2.8rem}}#toc-slider{position:absolute;margin-left:15px}#TableOfContents{padding-left:12px;border-left:2px solid rgba(88,88,88,.1);overflow:hidden;max-height:calc(100vh - 60px)}#TableOfContents ul li{list-style-type:none;font-size:13px;margin-top:.4rem}#TableOfContents ul{margin-top:.1rem;margin-bottom:.1rem}#TableOfContents li,#TableOfContents ul{margin-left:5px;padding-left:0}#TableOfContents ul ul{margin-left:.6rem}#TableOfContents :hover{overflow:auto}#TableOfContents a{color:#555}#TableOfContents a.highlighted{color:#1565c0}#TableOfContents:hover{overflow:auto}.toc-fixed{position:fixed!important;top:15px;margin-top:0;overflow:hidden;z-index:1}.wiki-content-aside{left:250px;right:0}.wiki-category-aside,.wiki-content-aside{position:fixed;top:0;bottom:0;overflow:auto}.wiki-category-aside{left:0;width:250px;padding-left:10px}.wiki-category-aside a{color:inherit}.wiki-category-aside .navigation{cursor:pointer;padding-top:20px;display:flex;align-items:center;justify-content:center}.wiki-category-aside ul{list-style:none;padding-left:10px}.wiki-category-aside li{list-style:none;margin:10px 15px}.wiki-category-aside li .title{font-size:14px;font-weight:400}.pagination{margin-top:6rem;text-align:center;font-family:Lato,Helvetica,sans-serif}.pagination li{display:inline;text-align:center;font-weight:700}.pagination li span{margin:0;text-align:center;width:3.2rem}.pagination li a{font-weight:300}.pagination li a span{margin:0;text-align:center;width:3.2rem}.footer{width:100%;text-align:center;line-height:2rem;margin-bottom:1rem}.footer a{color:#1565c0}main.colorscheme-dark a{color:#42a5f5}main.colorscheme-dark h1,main.colorscheme-dark h2,main.colorscheme-dark h3,main.colorscheme-dark h4,main.colorscheme-dark h5,main.colorscheme-dark h6{color:#dadada}main.colorscheme-dark code{background-color:#424242;color:#dadada}main.colorscheme-dark pre code{background-color:inherit;color:inherit}main.colorscheme-dark blockquote{border-left:2px solid #424242}main.colorscheme-dark table td,main.colorscheme-dark table th{border:2px solid #dadada}main.colorscheme-dark blockquote{border-left:4px solid #424242}main.colorscheme-dark #TableOfContents a{color:#dadada}main.colorscheme-dark #TableOfContents a.highlighted{color:#79aae6}@media (prefers-color-scheme:dark){main.colorscheme-auto{color:#dadada;background-color:#212121}main.colorscheme-auto a{color:#42a5f5}main.colorscheme-auto h1,main.colorscheme-auto h2,main.colorscheme-auto h3,main.colorscheme-auto h4,main.colorscheme-auto h5,main.colorscheme-auto h6{color:#dadada}main.colorscheme-auto code{background-color:#424242;color:#dadada}main.colorscheme-auto pre code{background-color:inherit;color:inherit}main.colorscheme-auto blockquote{border-left:2px solid #424242}main.colorscheme-auto table td,main.colorscheme-auto table th{border:2px solid #dadada}main.colorscheme-auto blockquote{border-left:4px solid #424242}main.colorscheme-auto #TableOfContents a{color:#dadada}main.colorscheme-auto #TableOfContents a.highlighted{color:#79aae6}}main.colorscheme-dark{color:#dadada;background-color:#212121}main.colorscheme-dark .content article strong{color:#dadada!important}main.colorscheme-dark .content .list ul li .title{color:#dadada}main.colorscheme-dark .content .list ul li .title:focus,main.colorscheme-dark .content .list ul li .title:hover{color:#42a5f5}main.colorscheme-dark .content .centered .about ul li a{color:#dadada}main.colorscheme-dark .content .centered .about ul li a:focus,main.colorscheme-dark .content .centered .about ul li a:hover{color:#42a5f5}@media (prefers-color-scheme:dark){main.colorscheme-auto{color:#dadada;background-color:#212121}main.colorscheme-auto .content article strong{color:#dadada!important}main.colorscheme-auto .content .list ul li .title{color:#dadada}main.colorscheme-auto .content .list ul li .title:focus,main.colorscheme-auto .content .list ul li .title:hover{color:#42a5f5}main.colorscheme-auto .content .centered .about ul li a{color:#dadada}main.colorscheme-auto .content .centered .about ul li a:focus,main.colorscheme-auto .content .centered .about ul li a:hover{color:#42a5f5}}main.colorscheme-dark .footer a{color:#42a5f5}@media (prefers-color-scheme:dark){main.colorscheme-auto .footer a{color:#42a5f5}}.container{max-width:1100px!important;width:80%}.colorscheme-dark .navigation .navigation-list .navigation-item .dropdown-content{background-color:#212121}.colorscheme-dark pre{color:#333}.wiki{width:100%!important;max-width:100%!important}.wiki #body-wrapper{width:100%}.wiki .post{max-width:100%!important}.wiki .wiki-cate-aside{font-weight:400;display:inline;float:left;visibility:visible;font-size:13px;width:240px;padding:0 20px 20px}.wiki .wiki-cate-aside ul{margin:0}.wiki .wiki-cate-aside a{font-size:13px;color:#555;font-weight:400}.wiki .wiki-cate-aside ol,.wiki .wiki-cate-aside ul{list-style:none;padding-left:20px}#articleWikiWrap{margin-left:240px}@media only screen and (max-width:900px){#articleWikiWrap{margin-left:0}#articleWikiAside{display:none}}code[class*=language-],pre[class*=language-]{color:#e3eaf2;background:0 0;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:#3c526d}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#3c526d}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#111b27}:not(pre)>code[class*=language-]{padding:.1em .3em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8da1b9}.token.punctuation{color:#e3eaf2}.token.delimiter.important,.token.selector .parent,.token.tag,.token.tag .token.punctuation{color:#6cc}.token.attr-name,.token.boolean,.token.boolean.important,.token.constant,.token.number,.token.selector .token.attribute{color:#e6d37a}.token.class-name,.token.key,.token.parameter,.token.property,.token.property-access,.token.variable{color:#6cb8e6}.token.attr-value,.token.color,.token.inserted,.token.selector .token.value,.token.string,.token.string .token.url-link{color:#91d076}.token.builtin,.token.keyword-array,.token.package,.token.regex{color:#f4adf4}.token.function,.token.selector .token.class,.token.selector .token.id{color:#c699e3}.token.atrule .token.rule,.token.combinator,.token.keyword,.token.operator,.token.pseudo-class,.token.pseudo-element,.token.selector,.token.unit{color:#e9ae7e}.token.deleted,.token.important{color:#cd6660}.token.keyword-this,.token.this{color:#6cb8e6}.token.bold,.token.important,.token.keyword-this,.token.this{font-weight:700}.token.delimiter.important{font-weight:inherit}.token.italic{font-style:italic}.token.entity{cursor:help}.language-markdown .token.title,.language-markdown .token.title .token.punctuation{color:#6cb8e6;font-weight:700}.language-markdown .token.blockquote.punctuation{color:#f4adf4}.language-markdown .token.code{color:#6cc}.language-markdown .token.hr.punctuation{color:#6cb8e6}.language-markdown .token.url .token.content{color:#91d076}.language-markdown .token.url-link{color:#e6d37a}.language-markdown .token.list.punctuation{color:#f4adf4}.language-json .token.operator,.language-markdown .token.table-header{color:#e3eaf2}.language-scss .token.variable{color:#6cc}.token.cr:before,.token.lf:before,.token.space:before,.token.tab:not(:empty):before{color:#8da1b9}div.code-toolbar>.toolbar a,div.code-toolbar>.toolbar button{color:#111b27;background:#6cb8e6}div.code-toolbar>.toolbar a:focus,div.code-toolbar>.toolbar a:hover,div.code-toolbar>.toolbar button:focus,div.code-toolbar>.toolbar button:hover{color:#111b27;background:rgba(108,184,230,.8549);text-decoration:none}div.code-toolbar>.toolbar span,div.code-toolbar>.toolbar span:focus,div.code-toolbar>.toolbar span:hover{color:#111b27;background:#8da1b9}.line-highlight{background:rgba(60,82,109,.37255);background:linear-gradient(90deg,rgba(60,82,109,.37255) 70%,rgba(60,82,109,.33333))}.line-highlight:before,.line-highlight[data-end]:after{background-color:#8da1b9;color:#111b27;box-shadow:0 1px #3c526d}pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(141,161,185,.09412)}.line-numbers .line-numbers-rows{border-right:1px solid #0b121b;background:rgba(11,18,27,.47843)}.line-numbers-rows>span:before{color:rgba(141,161,185,.8549)}.rainbow-braces .token.punctuation.brace-level-1,.rainbow-braces .token.punctuation.brace-level-5,.rainbow-braces .token.punctuation.brace-level-9{color:#e6d37a}.rainbow-braces .token.punctuation.brace-level-10,.rainbow-braces .token.punctuation.brace-level-2,.rainbow-braces .token.punctuation.brace-level-6{color:#f4adf4}.rainbow-braces .token.punctuation.brace-level-11,.rainbow-braces .token.punctuation.brace-level-3,.rainbow-braces .token.punctuation.brace-level-7{color:#6cb8e6}.rainbow-braces .token.punctuation.brace-level-12,.rainbow-braces .token.punctuation.brace-level-4,.rainbow-braces .token.punctuation.brace-level-8{color:#c699e3}pre.diff-highlight>code .token.deleted:not(.prefix),pre>code.diff-highlight .token.deleted:not(.prefix){background-color:rgba(205,102,96,.12157)}pre.diff-highlight>code .token.inserted:not(.prefix),pre>code.diff-highlight .token.inserted:not(.prefix){background-color:rgba(145,208,118,.12157)}.command-line-prompt{border-right:1px solid #0b121b}.command-line-prompt>span:before{color:rgba(141,161,185,.8549)}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.wiki-content-aside[data-v-270c8e4a]{margin:0;padding-right:0;max-width:100%!important;padding-bottom:20px}a[data-v-4fce9e8d]{font-weight:400;word-break:break-all;color:inherit}.side-highlighted[data-v-4fce9e8d]{color:#1565c0}main.colorscheme-dark a[data-v-4fce9e8d]{color:inherit}main.colorscheme-dark .side-highlighted[data-v-4fce9e8d]{color:#1565c0}li[data-v-4fce9e8d]{margin:5px;line-height:1.5}li ul[data-v-4fce9e8d]{padding-left:0}</style><link rel="preload" href="/_nuxt/static/1631670601/wiki/content/iOS-G2-(%E8%BD%AC)WKWebView%20%E9%82%A3%E4%BA%9B%E5%9D%91/state.js" as="script"><link rel="preload" href="/_nuxt/static/1631670601/wiki/content/iOS-G2-(%E8%BD%AC)WKWebView%20%E9%82%A3%E4%BA%9B%E5%9D%91/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1631670601/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><main class="wrapper colorscheme-auto"><div class="content" data-v-270c8e4a><div class="wiki-category-aside" data-v-270c8e4a><div class="navigation" data-v-270c8e4a><div data-v-270c8e4a><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-left" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="fa svg-inline--fa fa-arrow-left fa-w-14" data-v-270c8e4a data-v-270c8e4a><path fill="currentColor" d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z" data-v-270c8e4a data-v-270c8e4a></path></svg> <span style="margin-left:8px" data-v-270c8e4a>Go back</span></div> <div style="padding:0 20px" data-v-270c8e4a>
        Home
      </div></div> <ul data-v-4fce9e8d data-v-270c8e4a><li class="directory" data-v-4fce9e8d><a href="#" data-role="directory" data-v-4fce9e8d><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="angle-down" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="fa svg-inline--fa fa-angle-down fa-w-10" data-v-4fce9e8d data-v-4fce9e8d><path fill="currentColor" d="M143 352.3L7 216.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.6c9.4-9.4 24.6-9.4 33.9 0l96.4 96.4 96.4-96.4c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-136 136c-9.2 9.4-24.4 9.4-33.8 0z" data-v-4fce9e8d data-v-4fce9e8d></path></svg>
      iOS-G2
    </a> <ul style="display:block" data-v-4fce9e8d><li class="file" data-v-4fce9e8d><a href="/wiki/content/appclip-preview-1" class="title" data-v-4fce9e8d>
          App Clips 简介
        </a></li><li class="file" data-v-4fce9e8d><a href="/wiki/content/iOS-G2-(%E8%AF%91)wkwebview%E4%B8%80%E4%BA%9Btips" class="title" data-v-4fce9e8d>
          (译)wkwebview一些tips
        </a></li><li class="file" data-v-4fce9e8d><a href="/wiki/content/iOS-G2-telegram-iOS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1" class="title" data-v-4fce9e8d>
          telegram-iOS源码分析-启动
        </a></li><li class="file" data-v-4fce9e8d><a href="/wiki/content/iOS-G2-(%E8%BD%AC)WKWebView%20%E9%82%A3%E4%BA%9B%E5%9D%91" aria-current="page" class="title nuxt-link-exact-active nuxt-link-active side-highlighted" data-v-4fce9e8d>
          (转)bugly WKWebView 那些坑
        </a></li> <li class="directory" data-v-4fce9e8d><ul data-v-4fce9e8d data-v-4fce9e8d><li class="directory" data-v-4fce9e8d><a href="#" data-role="directory" data-v-4fce9e8d><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="angle-down" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="fa svg-inline--fa fa-angle-down fa-w-10" data-v-4fce9e8d data-v-4fce9e8d><path fill="currentColor" d="M143 352.3L7 216.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.6c9.4-9.4 24.6-9.4 33.9 0l96.4 96.4 96.4-96.4c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-136 136c-9.2 9.4-24.4 9.4-33.8 0z" data-v-4fce9e8d data-v-4fce9e8d></path></svg>
      AppClip
    </a> <ul style="display:block" data-v-4fce9e8d><li class="file" data-v-4fce9e8d><a href="/wiki/content/AppClip-AppClip-note1" class="title" data-v-4fce9e8d>
          AppClip笔记（一）
        </a></li><li class="file" data-v-4fce9e8d><a href="/wiki/content/AppClip-%E4%B8%80%E4%BA%9B%E5%85%B3%E4%BA%8EAppClips%E7%9A%84%E7%AC%94%E8%AE%B0" class="title" data-v-4fce9e8d>
          一些关于AppClips的笔记(转载)
        </a></li> <li class="directory" data-v-4fce9e8d><!----></li></ul></li><li class="directory" data-v-4fce9e8d><a href="#" data-role="directory" data-v-4fce9e8d><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="angle-down" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="fa svg-inline--fa fa-angle-down fa-w-10" data-v-4fce9e8d data-v-4fce9e8d><path fill="currentColor" d="M143 352.3L7 216.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.6c9.4-9.4 24.6-9.4 33.9 0l96.4 96.4 96.4-96.4c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-136 136c-9.2 9.4-24.4 9.4-33.8 0z" data-v-4fce9e8d data-v-4fce9e8d></path></svg>
      Debug
    </a> <ul style="display:block" data-v-4fce9e8d><li class="file" data-v-4fce9e8d><a href="/wiki/content/Debug-DEBUG%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%BB%A5%E5%8F%8A%E7%8E%AF%E5%A2%83%E7%8A%B6%E6%80%81%E5%8C%BA%E5%88%86" class="title" data-v-4fce9e8d>
          DEBUG环境变量以及环境状态区分
        </a></li><li class="file" data-v-4fce9e8d><a href="/wiki/content/Debug-swift-test" class="title" data-v-4fce9e8d>
          单元测试和UI测试
        </a></li> <li class="directory" data-v-4fce9e8d><!----></li></ul></li><li class="directory" data-v-4fce9e8d><a href="#" data-role="directory" data-v-4fce9e8d><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="angle-down" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="fa svg-inline--fa fa-angle-down fa-w-10" data-v-4fce9e8d data-v-4fce9e8d><path fill="currentColor" d="M143 352.3L7 216.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.6c9.4-9.4 24.6-9.4 33.9 0l96.4 96.4 96.4-96.4c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-136 136c-9.2 9.4-24.4 9.4-33.8 0z" data-v-4fce9e8d data-v-4fce9e8d></path></svg>
      GCD
    </a> <ul style="display:block" data-v-4fce9e8d><li class="file" data-v-4fce9e8d><a href="/wiki/content/GCD-(%E8%BD%AC)%E4%BF%A1%E5%8F%B7%E9%87%8F" class="title" data-v-4fce9e8d>
          (转)GCD信号量
        </a></li> <li class="directory" data-v-4fce9e8d><!----></li></ul></li><li class="directory" data-v-4fce9e8d><a href="#" data-role="directory" data-v-4fce9e8d><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="angle-down" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="fa svg-inline--fa fa-angle-down fa-w-10" data-v-4fce9e8d data-v-4fce9e8d><path fill="currentColor" d="M143 352.3L7 216.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.6c9.4-9.4 24.6-9.4 33.9 0l96.4 96.4 96.4-96.4c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-136 136c-9.2 9.4-24.4 9.4-33.8 0z" data-v-4fce9e8d data-v-4fce9e8d></path></svg>
      Mass
    </a> <ul style="display:block" data-v-4fce9e8d><li class="file" data-v-4fce9e8d><a href="/wiki/content/Mass-ms-IQKeyboard-dissmiss-black" class="title" data-v-4fce9e8d>
          IQKeyboard dissmiss黑边问题
        </a></li><li class="file" data-v-4fce9e8d><a href="/wiki/content/Mass-ms-URLProtocolDemo" class="title" data-v-4fce9e8d>
          WkWebview+URLProtocol
        </a></li><li class="file" data-v-4fce9e8d><a href="/wiki/content/Mass-ms-env" class="title" data-v-4fce9e8d>
          sandboxReceipt
        </a></li><li class="file" data-v-4fce9e8d><a href="/wiki/content/Mass-swift-url-encoding" class="title" data-v-4fce9e8d>
          swift url编码问题（CharacterSet使用）
        </a></li><li class="file" data-v-4fce9e8d><a href="/wiki/content/Mass-work-issue" class="title" data-v-4fce9e8d>
          mess issue
        </a></li> <li class="directory" data-v-4fce9e8d><!----></li></ul></li><li class="directory" data-v-4fce9e8d><a href="#" data-role="directory" data-v-4fce9e8d><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="angle-down" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="fa svg-inline--fa fa-angle-down fa-w-10" data-v-4fce9e8d data-v-4fce9e8d><path fill="currentColor" d="M143 352.3L7 216.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.6c9.4-9.4 24.6-9.4 33.9 0l96.4 96.4 96.4-96.4c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-136 136c-9.2 9.4-24.4 9.4-33.8 0z" data-v-4fce9e8d data-v-4fce9e8d></path></svg>
      UICollectionView
    </a> <ul style="display:block" data-v-4fce9e8d><li class="file" data-v-4fce9e8d><a href="/wiki/content/UICollectionView-UICollectionView%E8%87%AA%E9%80%82%E5%BA%94%E9%AB%98%E5%BA%A6" class="title" data-v-4fce9e8d>
          UICollectionView自适应高度(autolayout)
        </a></li> <li class="directory" data-v-4fce9e8d><!----></li></ul></li><li class="directory" data-v-4fce9e8d><a href="#" data-role="directory" data-v-4fce9e8d><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="angle-down" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="fa svg-inline--fa fa-angle-down fa-w-10" data-v-4fce9e8d data-v-4fce9e8d><path fill="currentColor" d="M143 352.3L7 216.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.6c9.4-9.4 24.6-9.4 33.9 0l96.4 96.4 96.4-96.4c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-136 136c-9.2 9.4-24.4 9.4-33.8 0z" data-v-4fce9e8d data-v-4fce9e8d></path></svg>
      UIView
    </a> <ul style="display:block" data-v-4fce9e8d><li class="file" data-v-4fce9e8d><a href="/wiki/content/UIView-uiview-shadow" class="title" data-v-4fce9e8d>
          UIView圆角阴影
        </a></li> <li class="directory" data-v-4fce9e8d><!----></li></ul></li></ul></li></ul></li></ul></div> <div class="wiki-content-aside" data-v-270c8e4a><section class="container post" style="width:100%" data-v-270c8e4a><article data-v-270c8e4a><header data-v-ff468d3a data-v-270c8e4a><div class="post-title" data-v-ff468d3a><h1 class="title" data-v-ff468d3a>(转)bugly WKWebView 那些坑</h1></div> <div class="post-meta" data-v-ff468d3a><div class="date" data-v-ff468d3a><span class="posted-on" data-v-ff468d3a><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="calendar-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="fa svg-inline--fa fa-calendar-alt fa-w-14" data-v-ff468d3a data-v-ff468d3a><path fill="currentColor" d="M0 464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V192H0v272zm320-196c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zM192 268c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zM64 268c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40zM400 64h-48V16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v48H160V16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v48H48C21.5 64 0 85.5 0 112v48h448v-48c0-26.5-21.5-48-48-48z" data-v-ff468d3a data-v-ff468d3a></path></svg> <time datetime="2020-06-25 11:32:22" data-v-ff468d3a>
                May 3, 2020
              </time></span></div> <div class="categories" data-v-ff468d3a><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="folder" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="fa svg-inline--fa fa-folder fa-w-16" data-v-ff468d3a data-v-ff468d3a><path fill="currentColor" d="M464 128H272l-64-64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48z" data-v-ff468d3a data-v-ff468d3a></path></svg> <a href="/wiki/#iOS-G2" data-v-ff468d3a> iOS-G2</a></div> <!----></div></header> <aside id="body-wrapper" data-v-270c8e4a><div id="contents" class="body-content co-width-10" data-v-270c8e4a><div class="nuxt-content" data-v-270c8e4a data-v-270c8e4a><p data-v-270c8e4a data-v-270c8e4a><a href="https://cloud.tencent.com/developer/article/1071660" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>原文地址</a> 文章年代略久，但总全面，可以作参考。</p>
<h2 id="导语" data-v-270c8e4a data-v-270c8e4a><a href="#%E5%AF%BC%E8%AF%AD" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>导语</h2>
<p data-v-270c8e4a data-v-270c8e4a>WKWebView 是苹果在 WWDC 2014 上推出的新一代 webView 组件，用以替代 UIKit 中笨重难用、内存泄漏的 UIWebView。WKWebView 拥有60fps滚动刷新率、和 safari 相同的 JavaScript 引擎等优势。</p>
<p data-v-270c8e4a data-v-270c8e4a>简单的适配方法本文不再赘述，主要来说说适配 WKWebView 过程中填过的坑以及善待解决的技术难题。</p>
<h2 id="1、wkwebview-白屏问题" data-v-270c8e4a data-v-270c8e4a><a href="#1%E3%80%81wkwebview-%E7%99%BD%E5%B1%8F%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>1、WKWebView 白屏问题</h2>
<p data-v-270c8e4a data-v-270c8e4a>WKWebView 自诩拥有更快的加载速度，更低的内存占用，但实际上 WKWebView 是一个多进程组件，Network Loading 以及 UI Rendering 在其它进程中执行。初次适配 WKWebView 的时候，我们也惊讶于打开 WKWebView 后，App 进程内存消耗反而大幅下降，但是仔细观察会发现，Other Process 的内存占用会增加。在一些用 webGL 渲染的复杂页面，使用 WKWebView 总体的内存占用（App Process Memory + Other Process Memory）不见得比 UIWebView 少很多。</p>
<p data-v-270c8e4a data-v-270c8e4a>在 UIWebView 上当内存占用太大的时候，App Process 会 crash；而在 WKWebView 上当总体的内存占用比较大的时候，WebContent Process 会 crash，从而出现白屏现象。在 WKWebView 中加载下面的测试链接可以稳定重现白屏现象:</p>
<blockquote data-v-270c8e4a data-v-270c8e4a>
<p data-v-270c8e4a data-v-270c8e4a><a href="http://people.mozilla.org/~rnewman/fennec/mem.html" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>http://people.mozilla.org/~rnewman/fennec/mem.html</a></p>
</blockquote>
<p data-v-270c8e4a data-v-270c8e4a>这个时候 WKWebView.URL 会变为 nil, 简单的 reload 刷新操作已经失效，对于一些长驻的H5页面影响比较大。</p>
<p data-v-270c8e4a data-v-270c8e4a>我们最后的解决方案是：</p>
<p data-v-270c8e4a data-v-270c8e4a>A、<strong data-v-270c8e4a data-v-270c8e4a>借助 WKNavigtionDelegate</strong></p>
<p data-v-270c8e4a data-v-270c8e4a>iOS 9以后 WKNavigtionDelegate 新增了一个回调函数：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-text" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a>- (void)webViewWebContentProcessDidTerminate:(WKWebView *)webView API_AVAILABLE(macosx(10.11), ios(9.0));
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>当 WKWebView 总体内存占用过大，页面即将白屏的时候，系统会调用上面的回调函数，我们在该函数里执行<code data-v-270c8e4a data-v-270c8e4a>[webView reload]</code>(这个时候 webView.URL 取值尚不为 nil）解决白屏问题。在一些高内存消耗的页面可能会频繁刷新当前页面，H5侧也要做相应的适配操作。</p>
<p data-v-270c8e4a data-v-270c8e4a>B、<strong data-v-270c8e4a data-v-270c8e4a>检测 webView.title 是否为空</strong></p>
<p data-v-270c8e4a data-v-270c8e4a>并不是所有H5页面白屏的时候都会调用上面的回调函数，比如，最近遇到在一个高内存消耗的H5页面上 present 系统相机，拍照完毕后返回原来页面的时候出现白屏现象（拍照过程消耗了大量内存，导致内存紧张，WebContent Process 被系统挂起），但上面的回调函数并没有被调用。在WKWebView白屏的时候，另一种现象是 webView.titile 会被置空, 因此，可以在 viewWillAppear 的时候检测 webView.title 是否为空来 reload 页面。</p>
<p data-v-270c8e4a data-v-270c8e4a>综合以上两种方法可以解决绝大多数的白屏问题。</p>
<h2 id="2、wkwebview-cookie-问题" data-v-270c8e4a data-v-270c8e4a><a href="#2%E3%80%81wkwebview-cookie-%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>2、WKWebView Cookie 问题</h2>
<p data-v-270c8e4a data-v-270c8e4a>Cookie 问题是目前 WKWebView 的一大短板</p>
<h3 id="21、wkwebview-cookie存储" data-v-270c8e4a data-v-270c8e4a><a href="#21%E3%80%81wkwebview-cookie%E5%AD%98%E5%82%A8" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>2.1、WKWebView Cookie存储</h3>
<p data-v-270c8e4a data-v-270c8e4a><strong data-v-270c8e4a data-v-270c8e4a>业界普遍认为 WKWebView 拥有自己的私有存储</strong>，不会将 Cookie 存入到标准的 Cookie 容器 NSHTTPCookieStorage 中。</p>
<p data-v-270c8e4a data-v-270c8e4a>实践发现 WKWebView 实例其实也会将 Cookie 存储于 NSHTTPCookieStorage 中，但存储时机有延迟:</p>
<ul data-v-270c8e4a data-v-270c8e4a>
<li data-v-270c8e4a data-v-270c8e4a>在iOS 8上，当页面跳转的时候，当前页面的 Cookie 会写入 NSHTTPCookieStorage 中</li>
<li data-v-270c8e4a data-v-270c8e4a>在 iOS 10 上，JS 执行 document.cookie 或服务器 set-cookie 注入的 Cookie 会很快同步到 NSHTTPCookieStorage 中，FireFox 工程师曾建议通过 reset WKProcessPool 来触发 Cookie 同步到 NSHTTPCookieStorage 中，实践发现不起作用，并可能会引发当前页面 session cookie 丢失等问题。</li>
</ul>
<p data-v-270c8e4a data-v-270c8e4a>WKWebView Cookie 问题在于:<strong data-v-270c8e4a data-v-270c8e4a>WKWebView 发起的请求不会自动带上存储于 NSHTTPCookieStorage 容器中的 Cookie</strong>。</p>
<p data-v-270c8e4a data-v-270c8e4a>比如，NSHTTPCookieStorage 中存储了一个 Cookie:</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-js" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a>name<span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span><span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>Nicholas</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span>value<span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span>test<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span>domain<span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span>y<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token property-access" data-v-270c8e4a data-v-270c8e4a>qq</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token property-access" data-v-270c8e4a data-v-270c8e4a>com</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span>expires<span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span><span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>Sat</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>02</span> <span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>May</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>2019</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>23</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token number" data-v-270c8e4a data-v-270c8e4a>38</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token number" data-v-270c8e4a data-v-270c8e4a>25</span> <span class="token constant" data-v-270c8e4a data-v-270c8e4a>GMT</span>；
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>通过 UIWebView 发起请求<a href="http://y.qq.com%EF%BC%8C" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>http://y.qq.com，</a> 则请求头会自动带上 cookie: Nicholas=test；
而通过 WKWebView发起请求<a href="http://y.qq.com%EF%BC%8C" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>http://y.qq.com，</a> 请求头<strong data-v-270c8e4a data-v-270c8e4a>不会</strong>自动带上 cookie: Nicholas=test。</p>
<h3 id="22、wkprocesspool" data-v-270c8e4a data-v-270c8e4a><a href="#22%E3%80%81wkprocesspool" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>2.2、WKProcessPool</h3>
<p data-v-270c8e4a data-v-270c8e4a>苹果开发者文档对 WKProcessPool 的定义是：<code data-v-270c8e4a data-v-270c8e4a>A WKProcessPool object represents a pool of Web Content process</code>. 通过让所有 WKWebView 共享同一个 WKProcessPool 实例，可以<strong data-v-270c8e4a data-v-270c8e4a>实现多个 WKWebView 之间共享 Cookie（session Cookie and persistent Cookie）数据</strong>。不过 WKWebView WKProcessPool 实例在 app 杀进程重启后会被重置，导致 WKProcessPool 中的 Cookie、session Cookie 数据丢失，目前也无法实现 WKProcessPool 实例本地化保存。</p>
<h3 id="23、workaround" data-v-270c8e4a data-v-270c8e4a><a href="#23%E3%80%81workaround" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>2.3、Workaround</h3>
<p data-v-270c8e4a data-v-270c8e4a>由于许多 H5 业务都依赖于 Cookie 作登录态校验，而 WKWebView 上请求不会自动携带 Cookie, 目前的主要解决方案是：</p>
<p data-v-270c8e4a data-v-270c8e4a>a、WKWebView loadRequest 前，在 request header 中设置 Cookie, 解决首个请求 Cookie 带不上的问题；</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-text" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a>WKWebView * webView = [WKWebView new]; 
NSMutableURLRequest * request = [NSMutableURLRequest requestWithURL:[NSURL URLWithString:@"http://h5.qzone.qq.com/mqzone/index"]]; 
[request addValue:@"skey=skeyValue" forHTTPHeaderField:@"Cookie"]; 
[webView loadRequest:request];
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>b、通过 document.cookie 设置 Cookie 解决后续页面(同域)Ajax、iframe 请求的 Cookie 问题；<strong data-v-270c8e4a data-v-270c8e4a>注意：document.cookie()无法跨域设置 cookie</strong></p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-js" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>WKUserContentController</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span> userContentController <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>WKUserContentController</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>new</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
<span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>WKUserScript</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span> cookieScript <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>WKUserScript</span> alloc<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> initWithSource<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span> @<span class="token string" data-v-270c8e4a data-v-270c8e4a>"document.cookie = 'skey=skeyValue';"</span> injectionTime<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>WKUserScriptInjectionTimeAtDocumentStart</span> forMainFrameOnly<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token constant" data-v-270c8e4a data-v-270c8e4a>NO</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 

<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span>userContentController addUserScript<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>cookieScript<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>这种方案无法解决302请求的 Cookie 问题，比如，第一个请求是 <a href="http://www.a.com%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%E5%9C%A8" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>www.a.com，我们通过在</a> request header 里带上 Cookie 解决该请求的 Cookie 问题，接着页面302跳转到 <a href="http://www.b.com%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%97%B6%E5%80%99" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>www.b.com，这个时候</a> <a href="http://www.b.com" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>www.b.com</a> 这个请求就可能因为没有携带 cookie 而无法访问。当然，由于每一次页面跳转前都会调用回调函数：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-text" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a>- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler;
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>(<a href="https://stackoverflow.com/questions/47754208/wkwebview-backforwardlist-getting-messed-up-when-going-back" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>笔者注:但是可能会造成调用goback的循环</a>,笔者认为是否可以可以判断如果backlist包含了此网址，就不进行cancel再拼接，但是仍然不完美,示例如下)。</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-swift" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>func</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>requestAddCookie</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>request<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>NSURLRequest</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>></span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>NSURLRequest</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>var</span> fixeReq<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>NSMutableURLRequest</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> mReq <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> request <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>as</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>NSMutableURLRequest</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            fixeReq <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> mReq
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>else</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> q <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> request<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>mutableCopy</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>as</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>NSMutableURLRequest</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
                fixeReq <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> q
            <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
        <span class="token comment" data-v-270c8e4a data-v-270c8e4a>//add cookie</span>
        <span class="token comment" data-v-270c8e4a data-v-270c8e4a>//fixeReq.addValue(self.generateCookieKeyValue(cookieDic), forHTTPHeaderField: "Cookie")</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> fixeReq <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> fixeReq <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>return</span> fixeReq
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>return</span> request
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>

    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>func</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>hasAppCookie</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>request<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>NSURLRequest</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>></span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>Bool</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> keys <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> request<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>allHTTPHeaderFields<span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>keys <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> keys<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>contains</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"Cookie"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
                <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> value <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> request<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>allHTTPHeaderFields<span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"Cookie"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
                    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> value<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>contains</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"access_token"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
                        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>return</span> <span class="token boolean" data-v-270c8e4a data-v-270c8e4a>true</span>
                    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
                <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
            <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>return</span> <span class="token boolean" data-v-270c8e4a data-v-270c8e4a>false</span>
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>func</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>webView</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token number" data-v-270c8e4a data-v-270c8e4a>_</span> webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>WKWebView</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> decidePolicyFor navigationAction<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>WKNavigationAction</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> decisionHandler<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> @escaping <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>WKNavigationActionPolicy</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>></span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>Void</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
        <span class="token comment" data-v-270c8e4a data-v-270c8e4a>//但是这样写会造成 goback循环</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>self</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>hasAppCookie</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>request<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> navigationAction<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>request <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>as</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>NSURLRequest</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            <span class="token function" data-v-270c8e4a data-v-270c8e4a>decisionHandler</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>allow<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>else</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>load</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>self</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>requestAddCookie</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>request<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> navigationAction<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>request <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>as</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>NSURLRequest</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>as</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>URLRequest</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            <span class="token function" data-v-270c8e4a data-v-270c8e4a>decisionHandler</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>cancel<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>可以在该回调函数里拦截302请求，copy request，在 request header 中带上 cookie 并重新 loadRequest。不过这种方法依然解决不了页面 iframe 跨域请求的 Cookie 问题，毕竟<code data-v-270c8e4a data-v-270c8e4a>-[WKWebView loadRequest:]</code>只适合加载 mainFrame 请求。</p>
<h2 id="3、wkwebview-nsurlprotocol问题" data-v-270c8e4a data-v-270c8e4a><a href="#3%E3%80%81wkwebview-nsurlprotocol%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>3、WKWebView NSURLProtocol问题</h2>
<p data-v-270c8e4a data-v-270c8e4a>WKWebView 在独立于 app 进程之外的进程中执行网络请求，请求数据不经过主进程，因此，在 WKWebView 上直接使用 NSURLProtocol 无法拦截请求。苹果开源的 webKit2 源码暴露了私有API：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-js" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token operator" data-v-270c8e4a data-v-270c8e4a>+</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>WKBrowsingContextController</span> registerSchemeForCustomProtocol<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>通过注册 http(s) scheme 后 WKWebView 将可以使用 NSURLProtocol 拦截 http(s) 请求：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-text" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a>Class cls = NSClassFromString(@"WKBrowsingContextController”); 
SEL sel = NSSelectorFromString(@"registerSchemeForCustomProtocol:"); 
if ([(id)cls respondsToSelector:sel]) { 
           // 注册http(s) scheme, 把 http和https请求交给 NSURLProtocol处理 
           [(id)cls performSelector:sel withObject:@"http"]; 
           [(id)cls performSelector:sel withObject:@"https"]; 
}
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>但是这种方案目前存在两个严重缺陷：</p>
<p data-v-270c8e4a data-v-270c8e4a>a、post 请求 body 数据被清空
由于 WKWebView 在独立进程里执行网络请求。一旦注册 http(s) scheme 后，网络请求将从 Network Process 发送到 App Process，这样 NSURLProtocol 才能拦截网络请求。在 webkit2 的设计里使用 MessageQueue 进行进程之间的通信，Network Process 会将请求 encode 成一个 Message,然后通过 IPC 发送给 App Process。出于性能的原因，encode 的时候 HTTPBody 和 HTTPBodyStream 这两个字段被丢弃掉了</p>
<p data-v-270c8e4a data-v-270c8e4a>参考：<a href="https://github.com/WebKit/webkit/blob/fe39539b83d28751e86077b173abd5b7872ce3f9/Source/WebKit2/Shared/mac/WebCoreArgumentCodersMac.mm#L61-L88" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>苹果源码</a></p>
<p data-v-270c8e4a data-v-270c8e4a>及bug report:</p>
<p data-v-270c8e4a data-v-270c8e4a><a href="https://bugs.webkit.org/show_bug.cgi?id=138169" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>https://bugs.webkit.org/show_bug.cgi?id=138169</a> （复制链接到浏览器中打开）</p>
<p data-v-270c8e4a data-v-270c8e4a>因此，如果通过 registerSchemeForCustomProtocol 注册了 http(s) scheme, 那么由 WKWebView 发起的所有 http(s)请求都会通过 IPC 传给主进程 NSURLProtocol 处理，导致 post 请求 body 被清空；</p>
<p data-v-270c8e4a data-v-270c8e4a>b、对ATS支持不足
测试发现一旦打开ATS开关：Allow Arbitrary Loads 选项设置为NO，同时通过 registerSchemeForCustomProtocol 注册了 http(s) scheme，WKWebView 发起的所有 http 网络请求将被阻塞（即便将Allow Arbitrary Loads in Web Content 选项设置为YES）；</p>
<p data-v-270c8e4a data-v-270c8e4a>WKWebView 可以注册 customScheme, 比如 dynamic://, 因此希望使用离线功能又不使用 post 方式的请求可以通过 customScheme 发起请求，比如 dynamic://<a href="http://www.dynamicalbumlocalimage.com/%EF%BC%8C%E7%84%B6%E5%90%8E%E5%9C%A8" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>www.dynamicalbumlocalimage.com/，然后在</a> app 进程 NSURLProtocol 拦截这个请求并加载离线数据。不足：使用 post 方式的请求该方案依然不适用，同时需要 H5 侧修改请求 scheme 以及 CSP 规则；</p>
<h2 id="4、wkwebview-loadrequest-问题" data-v-270c8e4a data-v-270c8e4a><a href="#4%E3%80%81wkwebview-loadrequest-%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>4、WKWebView loadRequest 问题</h2>
<p data-v-270c8e4a data-v-270c8e4a>在 WKWebView 上通过 loadRequest 发起的 post 请求 body 数据会丢失：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-text" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a>//同样是由于进程间通信性能问题，HTTPBody字段被丢弃
[request setHTTPMethod:@"POST"];
[request setHTTPBody:[@"bodyData" dataUsingEncoding:NSUTF8StringEncoding]];
[wkwebview loadRequest: request];
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>workaround:
假如想通过-[WKWebView loadRequest:]加载 post 请求 request1: <code data-v-270c8e4a data-v-270c8e4a>http://h5.qzone.qq.com/mqzone/index</code>,可以通过以下步骤实现：</p>
<ol data-v-270c8e4a data-v-270c8e4a>
<li data-v-270c8e4a data-v-270c8e4a>替换请求 scheme，生成新的 post 请求 request2: <code data-v-270c8e4a data-v-270c8e4a>post://h5.qzone.qq.com/mqzone/index</code>, 同时将 request1 的 body 字段复制到 request2 的 header 中（WebKit 不会丢弃 header 字段）;</li>
<li data-v-270c8e4a data-v-270c8e4a>通过-[WKWebView loadRequest:]加载新的 post 请求 request2;</li>
<li data-v-270c8e4a data-v-270c8e4a>通过 +[WKBrowsingContextController registerSchemeForCustomProtocol:]注册 scheme: <code data-v-270c8e4a data-v-270c8e4a>post://</code>;</li>
<li data-v-270c8e4a data-v-270c8e4a>注册 NSURLProtocol 拦截请求<code data-v-270c8e4a data-v-270c8e4a>post://h5.qzone.qq.com/mqzone/index</code> ,替换请求 scheme, 生成新的请求 request3: <code data-v-270c8e4a data-v-270c8e4a>http://h5.qzone.qq.com/mqzone/index</code>，将 request2 header的body 字段复制到 request3 的 body 中，并使用 NSURLConnection 加载 request3，最后通过 NSURLProtocolClient 将加载结果返回 WKWebView;</li>
</ol>
<h2 id="5、wkwebview-页面样式问题" data-v-270c8e4a data-v-270c8e4a><a href="#5%E3%80%81wkwebview-%E9%A1%B5%E9%9D%A2%E6%A0%B7%E5%BC%8F%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>5、WKWebView 页面样式问题</h2>
<p data-v-270c8e4a data-v-270c8e4a>在 WKWebView 适配过程中，我们发现部分H5页面元素位置向下偏移或被拉伸变形，追踪后发现主要是H5页面高度值异常导致：</p>
<p data-v-270c8e4a data-v-270c8e4a>a. 空间H5页面有透明导航、透明导航下拉刷新、全屏等需求，因此之前 webView 整个是从（0, 0）开始布局，通过调整webView.scrollView.contentInset 来适配特殊导航栏需求。而在 WKWebView 上对 contentInset 的调整会反馈到<code data-v-270c8e4a data-v-270c8e4a>webView.scrollView.contentSize.height</code>的变化上，比如设置 <code data-v-270c8e4a data-v-270c8e4a>webView.scrollView.contentInset.top = a</code>，那么contentSize.height的值会增加a,导致H5页面长度增加，页面元素位置向下偏移；</p>
<p data-v-270c8e4a data-v-270c8e4a>解决方案是：调整WKWebView布局方式，避免调整webView.scrollView.contentInset。实际上，即便在 UIWebView 上也不建议直接调整webView.scrollView.contentInset的值，这确实会带来一些奇怪的问题。如果某些特殊情况下非得调整 contentInset 不可的话，可以通过下面方式让H5页面恢复正常显示：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-java" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token doc-comment comment" data-v-270c8e4a data-v-270c8e4a>/**
 * 设置contentInset值后通过调整webView.frame让页面恢复正常显示 
 * 参考：http://km.oa.com/articles/show/277372
 */</span> 
webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>scrollView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>contentInset <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIEdgeInsetsMake</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>a<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>0</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>0</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>0</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>frame <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>CGRectMake</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>frame<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>origin<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>x<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>frame<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>origin<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>y<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>frame<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>size<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>width<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>frame<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>size<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>height <span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span> a<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>b. 在接入 now 直播的时候，我们发现在 iOS 9 上 WKWebView 会出现页面被拉伸变形的情况，最后发现是<code data-v-270c8e4a data-v-270c8e4a>window.innerHeight</code>值不准确导致（在WKWebView上返回了一个非常大的值），而H5同学通过获取window.innerHeight来设置页面高度，导致页面整体被拉伸。通过查阅相关资料发现，这个bug只在 iOS 9 的几个系统版本上出现，苹果后来fix了这个bug。我们最后的解决方案是：<strong data-v-270c8e4a data-v-270c8e4a>延迟调用window.innerHeight</strong></p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-js" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token function" data-v-270c8e4a data-v-270c8e4a>setTimeout</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>function</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>height <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token dom variable" data-v-270c8e4a data-v-270c8e4a>window</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token property-access" data-v-270c8e4a data-v-270c8e4a>innerHeight</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span><span class="token number" data-v-270c8e4a data-v-270c8e4a>0</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>or</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-js" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>Use</span> shrink<span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span>to<span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span>fit meta<span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span>tag 
<span class="token operator" data-v-270c8e4a data-v-270c8e4a>&lt;</span>meta name<span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"viewport"</span> content<span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1, shrink-to-fit=no"</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>></span>
</code></pre></div>
<h2 id="6-wkwebview-截屏问题" data-v-270c8e4a data-v-270c8e4a><a href="#6-wkwebview-%E6%88%AA%E5%B1%8F%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>6. WKWebView 截屏问题</h2>
<p data-v-270c8e4a data-v-270c8e4a>空间玩吧H5小游戏有截屏分享的功能，WKWebView 下通过 -[CALayer renderInContext:]实现截屏的方式失效，需要通过以下方式实现截屏功能：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-java" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token annotation punctuation" data-v-270c8e4a data-v-270c8e4a>@implementation</span> <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIView</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>ImageSnapshot</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> 
<span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIImage</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>imageSnapshot <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> 
    <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIGraphicsBeginImageContextWithOptions</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>self<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>bounds<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>size<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span>YES<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span>self<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>contentScaleFactor<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span>self drawViewHierarchyInRect<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>self<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>bounds afterScreenUpdates<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>YES<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIImage</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span> newImage <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIGraphicsGetImageFromCurrentImageContext</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIGraphicsEndImageContext</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>return</span> newImage<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span> 
<span class="token annotation punctuation" data-v-270c8e4a data-v-270c8e4a>@end</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>然而这种方式依然解决不了 webGL 页面的截屏问题，笔者已经翻遍苹果文档，研究过 webKit2 源码里的截屏私有API，依然没有找到合适的解决方案，同时发现 Safari 以及 Chrome 这两个全量切换到 WKWebView 的浏览器也存在同样的问题：对webGL 页面的截屏结果不是空白就是纯黑图片。无奈之下，我们只能约定一个JS接口，让游戏开发商实现该接口，具体是通过 <code data-v-270c8e4a data-v-270c8e4a>canvas getImageData()</code>方法取得图片数据后返回 base64 格式的数据，客户端在需要截图的时候，调用这个JS接口获取 base64 String 并转换成 UIImage。</p>
<h2 id="7wkwebview-crash问题" data-v-270c8e4a data-v-270c8e4a><a href="#7wkwebview-crash%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>7.WKWebView crash问题</h2>
<p data-v-270c8e4a data-v-270c8e4a>WKWebView 放量后，外网新增了一些 crash, 其中一类 crash 的主要堆栈如下：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-js" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token spread operator" data-v-270c8e4a data-v-270c8e4a>...</span> 
<span class="token number" data-v-270c8e4a data-v-270c8e4a>28</span> <span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>UIKit</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>0x0000000190513360</span> <span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>UIApplicationMain</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>+</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>208</span> 
<span class="token number" data-v-270c8e4a data-v-270c8e4a>29</span> <span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>Qzone</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>0x0000000101380570</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>main</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>main<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token property-access" data-v-270c8e4a data-v-270c8e4a>m</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token number" data-v-270c8e4a data-v-270c8e4a>181</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> 
<span class="token number" data-v-270c8e4a data-v-270c8e4a>30</span> libdyld<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token property-access" data-v-270c8e4a data-v-270c8e4a>dylib</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>0x00000001895205b8</span> _dyld_process_info_notify_release <span class="token operator" data-v-270c8e4a data-v-270c8e4a>+</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>36</span> 
<span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>Completion</span> handler passed to <span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token maybe-class-name" data-v-270c8e4a data-v-270c8e4a>QZWebController</span> webView<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>runJavaScriptAlertPanelWithMessage<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>initiatedByFrame<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>completionHandler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> was not called
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>主要是JS调用window.alert()函数引起的，从 crash 堆栈可以看出是 WKWebView 回调函数:</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-java" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token operator" data-v-270c8e4a data-v-270c8e4a>+</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> presentAlertOnController<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>nonnull <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIViewController</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>parentController title<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>nullable <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>NSString</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>title message<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>nullable <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>NSString</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>message handler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>nonnull <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>^</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>completionHandler<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>completionHandler 没有被调用导致的。在适配 WKWebView 的时候，我们需要自己实现该回调函数，window.alert()才能调起 alert 框，我们最初的实现是这样的：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-java" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>webView<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>WKWebView</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>webView runJavaScriptAlertPanelWithMessage<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>NSString</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>message initiatedByFrame<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>WKFrameInfo</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>frame completionHandler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>^</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>completionHandler 
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> 
    <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertController</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span>alertController <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertController</span> alertControllerWithTitle<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>@<span class="token string" data-v-270c8e4a data-v-270c8e4a>""</span> message<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>message preferredStyle<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertControllerStyleAlert</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span>alertController addAction<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertAction</span> actionWithTitle<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>@<span class="token string" data-v-270c8e4a data-v-270c8e4a>"确认"</span> style<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertActionStyleCancel</span> handler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>^</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertAction</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span>action<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>completionHandler</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span>self presentViewController<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>alertController animated<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>YES completion<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>^</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>如果 WKWebView 退出的时候，JS刚好执行了window.alert(), alert 框可能弹不出来，completionHandler 最后没有被执行，导致 crash；另一种情况是在 WKWebView 一打开，JS就执行window.alert()，这个时候由于 WKWebView 所在的 UIViewController 出现（push或present）的动画尚未结束，alert 框可能弹不出来，completionHandler 最后没有被执行，导致 crash。我们最终的实现大致是这样的：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-java" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>webView<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>WKWebView</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>webView runJavaScriptAlertPanelWithMessage<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>NSString</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>message initiatedByFrame<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>WKFrameInfo</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>frame completionHandler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>^</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>completionHandler 
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> 
    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token comment" data-v-270c8e4a data-v-270c8e4a>/*UIViewController of WKWebView has finish push or present animation*/</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> 
        <span class="token function" data-v-270c8e4a data-v-270c8e4a>completionHandler</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>return</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span> 
    <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertController</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span>alertController <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertController</span> alertControllerWithTitle<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>@<span class="token string" data-v-270c8e4a data-v-270c8e4a>""</span> message<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>message preferredStyle<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertControllerStyleAlert</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span>alertController addAction<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertAction</span> actionWithTitle<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>@<span class="token string" data-v-270c8e4a data-v-270c8e4a>"确认"</span> style<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertActionStyleCancel</span> handler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>^</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIAlertAction</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span>action<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>completionHandler</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token comment" data-v-270c8e4a data-v-270c8e4a>/*UIViewController of WKWebView is visible*/</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> 
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span>self presentViewController<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>alertController animated<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>YES completion<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>^</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>else</span> 
        <span class="token function" data-v-270c8e4a data-v-270c8e4a>completionHandler</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>确保上面两种情况下 completionHandler 都能被执行，消除了 WKWebView 下弹 alert 框的 crash，WKWebView 下弹 confirm 框的 crash 的原因与解决方式与 alert 类似。</p>
<p data-v-270c8e4a data-v-270c8e4a>另一个 crash 发生在 WKWebView 退出前调用：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-java" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>WKWebView</span> evaluateJavaScript<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span> completionHandler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span>
</code></pre></div>
<p data-v-270c8e4a data-v-270c8e4a>执行JS代码的情况下。WKWebView 退出并被释放后导致completionHandler变成野指针，而此时 javaScript Core 还在执行JS代码，待 javaScript Core 执行完毕后会调用completionHandler()，导致 crash。这个 crash 只发生在 iOS 8 系统上，参考Apple Open Source，在iOS9及以后系统苹果已经修复了这个bug，主要是对completionHandler block做了copy（refer: <a href="https://trac.webkit.org/changeset/179160%EF%BC%89%EF%BC%9B%E5%AF%B9%E4%BA%8EiOS" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>https://trac.webkit.org/changeset/179160）；对于iOS</a> 8系统，可以通过在 completionHandler 里 retain WKWebView 防止 completionHandler 被过早释放。我们最后用 methodSwizzle hook 了这个系统方法：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-java" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token operator" data-v-270c8e4a data-v-270c8e4a>+</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> load 
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> 
     <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span>self jr_swizzleMethod<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>NSSelectorFromString</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>@<span class="token string" data-v-270c8e4a data-v-270c8e4a>"evaluateJavaScript:completionHandler:"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> withMethod<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token annotation punctuation" data-v-270c8e4a data-v-270c8e4a>@selector</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>altEvaluateJavaScript<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>completionHandler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> error<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>nil<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span> 
<span class="token comment" data-v-270c8e4a data-v-270c8e4a>/* 
 * fix: WKWebView crashes on deallocation if it has pending JavaScript evaluation 
 */</span> 
<span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>altEvaluateJavaScript<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>NSString</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>javaScriptString completionHandler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>^</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>id<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>NSError</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>completionHandler 
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> 
    id strongSelf <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> self<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span>self altEvaluateJavaScript<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span>javaScriptString completionHandler<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>^</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>id r<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>NSError</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span>e<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> 
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span>strongSelf title<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>completionHandler<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span> 
            <span class="token function" data-v-270c8e4a data-v-270c8e4a>completionHandler</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>r<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> e<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span> 
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span> 
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
</code></pre></div>
<h2 id="8、其它问题" data-v-270c8e4a data-v-270c8e4a><a href="#8%E3%80%81%E5%85%B6%E5%AE%83%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>8、其它问题</h2>
<h3 id="81、视频自动播放" data-v-270c8e4a data-v-270c8e4a><a href="#81%E3%80%81%E8%A7%86%E9%A2%91%E8%87%AA%E5%8A%A8%E6%92%AD%E6%94%BE" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>8.1、视频自动播放</h3>
<p data-v-270c8e4a data-v-270c8e4a>WKWebView 需要通过WKWebViewConfiguration.mediaPlaybackRequiresUserAction设置是否允许自动播放，但一定要在 WKWebView 初始化之前设置，在 WKWebView 初始化之后设置无效。</p>
<h3 id="82、goback-api问题" data-v-270c8e4a data-v-270c8e4a><a href="#82%E3%80%81goback-api%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>8.2、goBack API问题</h3>
<p data-v-270c8e4a data-v-270c8e4a>WKWebView 上调用 -[WKWebView goBack], 回退到上一个页面后不会触发window.onload()函数、不会执行JS。</p>
<h3 id="83、页面滚动速率" data-v-270c8e4a data-v-270c8e4a><a href="#83%E3%80%81%E9%A1%B5%E9%9D%A2%E6%BB%9A%E5%8A%A8%E9%80%9F%E7%8E%87" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>8.3、页面滚动速率</h3>
<p data-v-270c8e4a data-v-270c8e4a>WKWebView 需要通过scrollView delegate调整滚动速率：</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-java" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>void</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>scrollViewWillBeginDragging<span class="token operator" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIScrollView</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>scrollView <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
     scrollView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>decelerationRate <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token class-name" data-v-270c8e4a data-v-270c8e4a>UIScrollViewDecelerationRateNormal</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>;</span>
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
</code></pre></div>
<h2 id="9、结语" data-v-270c8e4a data-v-270c8e4a><a href="#9%E3%80%81%E7%BB%93%E8%AF%AD" aria-hidden="true" tabindex="-1" data-v-270c8e4a data-v-270c8e4a><span class="icon icon-link" data-v-270c8e4a data-v-270c8e4a></span></a>9、结语</h2>
<p data-v-270c8e4a data-v-270c8e4a>本文总结了在 WKWebView 上踩过的一些坑。虽然 WKWebView 坑比较多，但是相对 UIWebView 在内存消耗、稳定性方面还是有很大的优势。尽管苹果对 WKWebView 的开发进度过于缓慢，但相信 WKWebView 才是未来。</p>
<p data-v-270c8e4a data-v-270c8e4a>笔者其他参考</p>
<p data-v-270c8e4a data-v-270c8e4a><a href="https://www.jianshu.com/p/870dba42ec15" rel="nofollow noopener noreferrer" target="_blank" data-v-270c8e4a data-v-270c8e4a>iOS中UIWebView与WKWebView、JavaScript与OC交互、Cookie管理看我就够（中）</a></p>
<p data-v-270c8e4a data-v-270c8e4a>笔者注，wkwebview设置cookie的参考</p>
<div class="nuxt-content-highlight" data-v-270c8e4a data-v-270c8e4a><pre class="line-numbers language-swift" data-v-270c8e4a data-v-270c8e4a><code data-v-270c8e4a data-v-270c8e4a><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>import</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>WebKit</span>
<span class="token keyword" data-v-270c8e4a data-v-270c8e4a>extension</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>BxWebViewController</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>func</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>setWkCookieAndPush</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
        <span class="token comment" data-v-270c8e4a data-v-270c8e4a>// 删除旧Cookie</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> cookies <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookieStorage</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>shared<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>cookies
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>for</span> delCookie <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>in</span> cookies<span class="token operator" data-v-270c8e4a data-v-270c8e4a>!</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookieStorage</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>shared<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>deleteCookie</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>delCookie<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> #<span class="token function" data-v-270c8e4a data-v-270c8e4a>available</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>iOS <span class="token number" data-v-270c8e4a data-v-270c8e4a>11.0</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            <span class="token function" data-v-270c8e4a data-v-270c8e4a>setCookies</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> request <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>URLRequest</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>URL</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>string<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>!</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>self</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>load</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>request<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>else</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            <span class="token comment" data-v-270c8e4a data-v-270c8e4a>// 2. iOS11以下</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> cookieString <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>self</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>generateCookieInject</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> mutiRequest <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>NSMutableURLRequest</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>URL</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>string<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>!</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            mutiRequest<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>addValue</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token keyword" data-v-270c8e4a data-v-270c8e4a>self</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>generateCookieKeyValue</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> forHTTPHeaderField<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>"Cookie"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> cookiScript <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>WKUserScript</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>source<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> cookieString<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> injectionTime<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>WKUserScriptInjectionTime</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>atDocumentStart<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> forMainFrameOnly<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token boolean" data-v-270c8e4a data-v-270c8e4a>false</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>self</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>configuration<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>userContentController<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>addUserScript</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>cookiScript<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            <span class="token number" data-v-270c8e4a data-v-270c8e4a>_</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>self</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>load</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>mutiRequest <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>as</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>URLRequest</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>

    <span class="token comment" data-v-270c8e4a data-v-270c8e4a>// 1. 测试301没有问题</span>

    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>func</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>generateCookieInject</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token number" data-v-270c8e4a data-v-270c8e4a>_</span> cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>></span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>return</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>"document.cookie = 'access_token=<span class="token interpolation" data-v-270c8e4a data-v-270c8e4a><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>\(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"access_token"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>""</span><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>)</span></span>; path=/'; document.cookie = 'grayFlag = <span class="token interpolation" data-v-270c8e4a data-v-270c8e4a><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>\(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"grayFlag"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>"false"</span><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>)</span></span>; path=/'; document.cookie='public_no_code=<span class="token interpolation" data-v-270c8e4a data-v-270c8e4a><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>\(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"public_no_code"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>""</span><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>)</span></span>;path=/'; document.cookie ='requestType=<span class="token interpolation" data-v-270c8e4a data-v-270c8e4a><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>\(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"requestType"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>"native"</span><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>)</span></span>; path=/'"</span>
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>

    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>private</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>func</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>generateCookieKeyValue</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span><span class="token number" data-v-270c8e4a data-v-270c8e4a>_</span> cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>-</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>></span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>return</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>"access_token=<span class="token interpolation" data-v-270c8e4a data-v-270c8e4a><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>\(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"access_token"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>""</span><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>)</span></span>; grayFlag=<span class="token interpolation" data-v-270c8e4a data-v-270c8e4a><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>\(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"grayFlag"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>"false"</span><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>)</span></span>; public_no_code=<span class="token interpolation" data-v-270c8e4a data-v-270c8e4a><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>\(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"public_no_code"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>""</span><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>)</span></span>; requestType=<span class="token interpolation" data-v-270c8e4a data-v-270c8e4a><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>\(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token string" data-v-270c8e4a data-v-270c8e4a>"requestType"</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>"native"</span><span class="token delimiter variable" data-v-270c8e4a data-v-270c8e4a>)</span></span>"</span>
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>

    @<span class="token function" data-v-270c8e4a data-v-270c8e4a>available</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>iOS <span class="token number" data-v-270c8e4a data-v-270c8e4a>11.0</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
    <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>func</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>setCookies</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>cookieDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>String</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
        <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>for</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>key<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>,</span> value<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>in</span> cookieDic <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>var</span> propertiesDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookiePropertyKey</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>Any</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span>
            propertiesDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookiePropertyKey</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>name<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> key
            propertiesDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookiePropertyKey</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>value<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> value
            propertiesDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookiePropertyKey</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>domain<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>URL</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>string<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span><span class="token operator" data-v-270c8e4a data-v-270c8e4a>?</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>host<span class="token operator" data-v-270c8e4a data-v-270c8e4a>!</span>
            propertiesDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookiePropertyKey</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>path<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>"/"</span>
            propertiesDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookiePropertyKey</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>expires<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>Date</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>timeIntervalSinceNow<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>60</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>60</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>24</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>*</span> <span class="token number" data-v-270c8e4a data-v-270c8e4a>7</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            propertiesDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookiePropertyKey</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>version<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token string" data-v-270c8e4a data-v-270c8e4a>"0"</span>
            propertiesDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>[</span><span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookiePropertyKey</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>originURL<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>]</span> <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>URL</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>string<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> url<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> newCookie <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token function" data-v-270c8e4a data-v-270c8e4a>HTTPCookie</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>properties<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>:</span> propertiesDic<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
            <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>if</span> newCookie <span class="token operator" data-v-270c8e4a data-v-270c8e4a>!=</span> <span class="token constant" data-v-270c8e4a data-v-270c8e4a>nil</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span>
                <span class="token builtin" data-v-270c8e4a data-v-270c8e4a>HTTPCookieStorage</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>shared<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>setCookie</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>newCookie<span class="token operator" data-v-270c8e4a data-v-270c8e4a>!</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span>
                <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>let</span> httpCookieStore <span class="token operator" data-v-270c8e4a data-v-270c8e4a>=</span> <span class="token keyword" data-v-270c8e4a data-v-270c8e4a>self</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>webView<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>configuration<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>websiteDataStore<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span>httpCookieStore
                httpCookieStore<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>.</span><span class="token function" data-v-270c8e4a data-v-270c8e4a>setCookie</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>(</span>newCookie<span class="token operator" data-v-270c8e4a data-v-270c8e4a>!</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>)</span> <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>{</span><span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
            <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
        <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
    <span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
<span class="token punctuation" data-v-270c8e4a data-v-270c8e4a>}</span>
</code></pre></div></div></div> <div class="sidebar co-width-2" style="padding-left:12px;display:none" data-v-270c8e4a><div class="toc-fixed" data-v-270c8e4a><nav id="TableOfContents" data-v-270c8e4a><ul data-v-270c8e4a><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#导语" data-v-270c8e4a> 导语 </a></li><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#1、wkwebview-白屏问题" data-v-270c8e4a> 1、WKWebView 白屏问题 </a></li><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#2、wkwebview-cookie-问题" data-v-270c8e4a> 2、WKWebView Cookie 问题 </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-270c8e4a><a href="#21、wkwebview-cookie存储" data-v-270c8e4a> 2.1、WKWebView Cookie存储 </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-270c8e4a><a href="#22、wkprocesspool" data-v-270c8e4a> 2.2、WKProcessPool </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-270c8e4a><a href="#23、workaround" data-v-270c8e4a> 2.3、Workaround </a></li><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#3、wkwebview-nsurlprotocol问题" data-v-270c8e4a> 3、WKWebView NSURLProtocol问题 </a></li><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#4、wkwebview-loadrequest-问题" data-v-270c8e4a> 4、WKWebView loadRequest 问题 </a></li><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#5、wkwebview-页面样式问题" data-v-270c8e4a> 5、WKWebView 页面样式问题 </a></li><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#6-wkwebview-截屏问题" data-v-270c8e4a> 6. WKWebView 截屏问题 </a></li><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#7wkwebview-crash问题" data-v-270c8e4a> 7.WKWebView crash问题 </a></li><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#8、其它问题" data-v-270c8e4a> 8、其它问题 </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-270c8e4a><a href="#81、视频自动播放" data-v-270c8e4a> 8.1、视频自动播放 </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-270c8e4a><a href="#82、goback-api问题" data-v-270c8e4a> 8.2、goBack API问题 </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-270c8e4a><a href="#83、页面滚动速率" data-v-270c8e4a> 8.3、页面滚动速率 </a></li><li class="py-2" style="text-indent:8px" data-v-270c8e4a><a href="#9、结语" data-v-270c8e4a> 9、结语 </a></li></ul></nav> <a href="#" id="tap-to-top" data-v-270c8e4a><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-up" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="svg-inline--fa fa-arrow-up fa-w-14" data-v-270c8e4a data-v-270c8e4a><path fill="currentColor" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z" data-v-270c8e4a data-v-270c8e4a></path></svg></a></div></div></aside></article></section></div></div></main></div></div><script defer src="/_nuxt/static/1631670601/wiki/content/iOS-G2-(%E8%BD%AC)WKWebView%20%E9%82%A3%E4%BA%9B%E5%9D%91/state.js"></script><script src="/_nuxt/js/runtime.1631670569310.js" defer></script><script src="/_nuxt/js/pages/wiki.1631670569310.js" defer></script><script src="/_nuxt/js/pages/wiki/content/_slug.1631670569310.js" defer></script><script src="/_nuxt/js/commons/app.1631670569310.js" defer></script><script src="/_nuxt/js/vendors/app.1631670569310.js" defer></script><script src="/_nuxt/js/app.1631670569310.js" defer></script>
  </body>
</html>
