<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>MISTJ</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" name="format-detection" content="telephone=no"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon.ico.png"><link rel="preload" href="/_nuxt/js/runtime.1637221086066.js" as="script"><link rel="preload" href="/_nuxt/js/commons/app.1637221086066.js" as="script"><link rel="preload" href="/_nuxt/js/vendors/app.1637221086066.js" as="script"><link rel="preload" href="/_nuxt/js/app.1637221086066.js" as="script"><link rel="preload" href="/_nuxt/js/pages/index.1637221086066.js" as="script"><link rel="preload" href="/_nuxt/js/pages/index/posts/content/_slug.1637221086066.js" as="script"><style data-vue-ssr-id="1a114e69:0 5fd7ed67:0 21344d92:0 387be0d0:0 fa7ff0ca:0 66e695b2:0 03540e68:0">*,:after,:before{box-sizing:inherit}html{box-sizing:border-box;font-size:62.5%}body{color:#333;margin:0;background-color:#fafafa;font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;font-size:1.6em;font-weight:300;line-height:1.8em}@media only screen and (max-width:768px){body{font-size:1.6em;line-height:1.6em}}a{font-weight:300;color:#1565c0;text-decoration:none}a:focus,a:hover{text-decoration:underline}p{margin:2rem 0}h1,h2,h3,h4,h5,h6{font-family:Lato,Helvetica,sans-serif;font-weight:700;color:#000;margin:6.4rem 0 3.2rem}h1{font-size:3.2rem;line-height:3.6rem}@media only screen and (max-width:768px){h1{font-size:3rem;line-height:3.4rem}}h2{font-size:2.8rem;line-height:3.2rem}@media only screen and (max-width:768px){h2{font-size:2.6rem;line-height:3rem}}h3{font-size:2.4rem;line-height:2.8rem}@media only screen and (max-width:768px){h3{font-size:2.2rem;line-height:2.6rem}}h4{font-size:2.2rem;line-height:2.6rem}@media only screen and (max-width:768px){h4{font-size:2rem;line-height:2.4rem}}h5{font-size:2rem;line-height:2.4rem}@media only screen and (max-width:768px){h5{font-size:1.8rem;line-height:2.2rem}}h6{font-size:1.8rem;line-height:2.2rem}@media only screen and (max-width:768px){h6{font-size:1.6rem;line-height:2rem}}b,strong{font-weight:700}.highlight>div,.highlight>pre{margin:0 0 2rem;padding:1rem;border-radius:1rem}pre{display:block;font-family:"Source Code Pro","Lucida Console",monospace;font-size:1.6rem;font-weight:400;line-height:2.6rem;overflow-x:auto;margin:0}pre code{display:inline-block;background-color:inherit;color:inherit}code{font-family:"Source Code Pro","Lucida Console",monospace;font-weight:400;background-color:#e0e0e0;color:#333}blockquote{border-left:2px solid #e0e0e0;padding-left:2rem;line-height:2.2rem;font-weight:400;font-style:italic}td,th{padding:1.6rem}table{border-collapse:collapse}table td,table th{border:2px solid #000}table tr:first-child th{border-top:0}table tr:last-child td{border-bottom:0}table tr td:first-child,table tr th:first-child{border-left:0}table tr td:last-child,table tr th:last-child{border-right:0}img{max-width:100%}figure{text-align:center}.wrapper{display:flex;flex-direction:column;min-height:100vh;width:100%}.container{margin:0 auto;max-width:90rem;width:100%;padding-left:2rem;padding-right:2rem}.fas{font-weight:700}.float-right{float:right}.float-left{float:left}.fab{font-weight:400}.fas{font-weight:900}img.emoji{height:1em;width:1em;margin:0 .05em 0 .1em;vertical-align:-.1em}#tap-to-top{display:none!important;z-index:90;position:fixed;bottom:2em;right:2em;top:auto;left:auto;color:#fafafa;padding:10px 16px;border:1px solid #fafafa;background-color:#333;transition:color .2s ease,border-color .2s ease,background .2s ease,opacity .2s ease}.toc-fixed #tap-to-top{display:inline-block!important}.flex{display:flex}.flex-y-center{display:flex;justify-content:center}.flex-align-center{display:flex;align-items:center}.content{flex:1;display:flex;margin-top:1.6rem;margin-bottom:3.2rem}.content article{width:100%;word-break:break-word;font-size:25.6px;font-size:1.6rem;line-height:1.6}.content article h1,.content article h1 *,.content article h2,.content article h2 *,.content article h3,.content article h3 *,.content article h4,.content article h4 *,.content article h5,.content article h5 *,.content article h6,.content article h6 *{word-break:break-all}.content article header{margin-top:6.4rem;margin-bottom:3.2rem}.content article header h1{font-size:4.2rem;line-height:4.6rem;margin:0}@media only screen and (max-width:768px){.content article header h1{font-size:4rem;line-height:4.4rem}}.content article footer{margin-top:4rem}.content article footer .see-also,.content article footer .see-also h3{margin:3.2rem 0}.content article div,.content article p{-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.content article a:hover{background:0 0}.content article img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}.content article blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}.content article blockquote:before{position:absolute}.content article blockquote *{margin:0;font-size:inherit}.content article table{margin:0 0 1.2em;border:none}.content article table td,.content article table th{border:none}.content article ul{margin:0 0 1.2em;padding:0;list-style:disc}.content article ul li{font-size:inherit;list-style:disc}.content article ul li *{margin:0;text-align:left;text-align:initial}.content article ol{list-style:decimal;margin:0;padding:0}.content article ol li{list-style:decimal}.content article ol li *{margin:0;text-align:left;text-align:initial}.content article li ol,.content article li ul{margin-left:2em}.content article li ul{list-style:circle}.content article .article-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.content article .article-center-small{display:inline-flex}.content article .article-center-small img{margin:0;padding:0;border:0;box-shadow:none}.content article .article-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}.content article h1,.content article h2,.content article h3,.content article h4,.content article h5,.content article h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#333}.content article h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}.content article h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}.content article h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}.content article h4{font-size:32px;font-size:2rem}.content article h5,.content article h6{font-size:25.6px;font-size:1.6rem}.content article h6{color:#777}.content article ol,.content article ul{list-style-type:disc;padding:0 0 0 2em}.content article ol ol,.content article ul ol{list-style-type:lower-roman}.content article ol ol ol,.content article ol ul ol,.content article ul ol ol,.content article ul ul ol{list-style-type:lower-alpha}.content article table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}.content article table tr{background-color:#fff;border-top:1px solid #ccc}.content article table th{font-weight:700}.content article table td,.content article table th{padding:6px 13px;border:1px solid #ddd}.content article blockquote{border-left:4px solid #ddd}.content article strong{font-weight:600!important;color:#000!important}.content article a:active,.content article a:focus,.content article a:hover{color:#4183c4;text-decoration:underline}.content article pre code,.content article pre code *{font-size:15px}.content article li code,.content article p code{border-radius:3px;font-size:90%;line-height:1.2;padding:.1rem .2rem;color:#d73e48;background:#fcf2f2}.content article h1,.content article h2{padding-top:1.7rem;padding-bottom:1.2rem;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAABCAYAAACsXeyTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQIHWNIS0sr/v//PwMMDzY+ADqMahlW4J91AAAAAElFTkSuQmCC) 0 100% repeat-x}.content article,.content article *,.content article div,.content article p{font-weight:400;line-height:1.8}.content .co-width-2{width:16.7%}.content .co-width-10{width:83.3%}.content .co-width-12{width:100%}.content .container{max-width:90rem}.content #body-wrapper{display:flex}.content .post .post-title{margin-bottom:.75em}.content .post .post-meta .fa{text-align:center;width:1.6rem;margin-left:0;margin-right:.5rem}.content .post .post-meta .date .posted-on,.content .post .post-meta .date .reading-time{margin-left:0;margin-right:1.5rem}@media only screen and (max-width:840px){.content #toc-slider{display:none}.content .body-content{width:100%}}.content figure{margin:0;padding:0}.content figcaption p{text-align:center;font-style:italic;font-size:1.6rem;margin:0}.avatar img{width:20rem;height:auto;border-radius:50%}@media only screen and (max-width:768px){.avatar img{width:10rem}}.list ul{margin:3.2rem 0;list-style:none;padding:0}.list ul li{font-size:1.8rem}@media only screen and (max-width:768px){.list ul li{margin:1.6rem 0}}.list ul li .date{display:inline-block;flex:1;width:20rem;text-align:right;margin-right:3rem}@media only screen and (max-width:768px){.list ul li .date{display:block;text-align:left}}.list ul li .title{font-size:1.8rem;flex:2;color:#333;font-family:Lato,Helvetica,sans-serif;font-weight:700}.list ul li .title:focus,.list ul li .title:hover{color:#1565c0}@media only screen and (min-width:768.1px){.list ul:not(.pagination) li{display:flex}}.centered{display:flex;align-items:center;justify-content:center}.centered .about{text-align:center}.centered .about h1{margin-top:2rem;margin-bottom:.5rem}.centered .about h2{margin-top:1rem;margin-bottom:.5rem;font-size:2.4rem}@media only screen and (max-width:768px){.centered .about h2{font-size:2rem}}.centered .about ul{list-style:none;margin:3rem 0 1rem;padding:0}.centered .about ul li{display:inline-block;position:relative}.centered .about ul li a{color:#333;text-transform:uppercase;margin-left:1rem;margin-right:1rem;font-size:1.6rem}.centered .about ul li a:focus,.centered .about ul li a:hover{color:#1565c0}@media only screen and (max-width:768px){.centered .about ul li a{font-size:1.4rem}}.centered .about ul li a i{font-size:3.2rem}.centered .error{text-align:center}.centered .error h1{margin-top:2rem;margin-bottom:.5rem;font-size:4.6rem}@media only screen and (max-width:768px){.centered .error h1{font-size:3.2rem}}.centered .error h2{margin-top:2rem;margin-bottom:3.2rem;font-size:3.2rem}@media only screen and (max-width:768px){.centered .error h2{font-size:2.8rem}}#toc-slider{position:absolute;margin-left:15px}#TableOfContents{padding-left:12px;border-left:2px solid rgba(88,88,88,.1);overflow:hidden;max-height:calc(100vh - 60px)}#TableOfContents ul li{list-style-type:none;font-size:13px;margin-top:.4rem}#TableOfContents ul{margin-top:.1rem;margin-bottom:.1rem}#TableOfContents li,#TableOfContents ul{margin-left:5px;padding-left:0}#TableOfContents ul ul{margin-left:.6rem}#TableOfContents :hover{overflow:auto}#TableOfContents a{color:#555}#TableOfContents a.highlighted{color:#1565c0}#TableOfContents:hover{overflow:auto}.toc-fixed{position:fixed!important;top:15px;margin-top:0;overflow:hidden;z-index:1}.wiki-content-aside{left:250px;right:0}.wiki-category-aside,.wiki-content-aside{position:fixed;top:0;bottom:0;overflow:auto}.wiki-category-aside{left:0;width:250px;padding-left:10px}.wiki-category-aside a{color:inherit}.wiki-category-aside .navigation{cursor:pointer;padding-top:20px;display:flex;align-items:center;justify-content:center}.wiki-category-aside ul{list-style:none;padding-left:10px}.wiki-category-aside li{list-style:none;margin:10px 15px}.wiki-category-aside li .title{font-size:14px;font-weight:400}.pagination{margin-top:6rem;text-align:center;font-family:Lato,Helvetica,sans-serif}.pagination li{display:inline;text-align:center;font-weight:700}.pagination li span{margin:0;text-align:center;width:3.2rem}.pagination li a{font-weight:300}.pagination li a span{margin:0;text-align:center;width:3.2rem}.footer{width:100%;text-align:center;line-height:2rem;margin-bottom:1rem}.footer a{color:#1565c0}main.colorscheme-dark a{color:#42a5f5}main.colorscheme-dark h1,main.colorscheme-dark h2,main.colorscheme-dark h3,main.colorscheme-dark h4,main.colorscheme-dark h5,main.colorscheme-dark h6{color:#dadada}main.colorscheme-dark code{background-color:#424242;color:#dadada}main.colorscheme-dark pre code{background-color:inherit;color:inherit}main.colorscheme-dark blockquote{border-left:2px solid #424242}main.colorscheme-dark table td,main.colorscheme-dark table th{border:2px solid #dadada}main.colorscheme-dark blockquote{border-left:4px solid #424242}main.colorscheme-dark #TableOfContents a{color:#dadada}main.colorscheme-dark #TableOfContents a.highlighted{color:#79aae6}@media (prefers-color-scheme:dark){main.colorscheme-auto{color:#dadada;background-color:#212121}main.colorscheme-auto a{color:#42a5f5}main.colorscheme-auto h1,main.colorscheme-auto h2,main.colorscheme-auto h3,main.colorscheme-auto h4,main.colorscheme-auto h5,main.colorscheme-auto h6{color:#dadada}main.colorscheme-auto code{background-color:#424242;color:#dadada}main.colorscheme-auto pre code{background-color:inherit;color:inherit}main.colorscheme-auto blockquote{border-left:2px solid #424242}main.colorscheme-auto table td,main.colorscheme-auto table th{border:2px solid #dadada}main.colorscheme-auto blockquote{border-left:4px solid #424242}main.colorscheme-auto #TableOfContents a{color:#dadada}main.colorscheme-auto #TableOfContents a.highlighted{color:#79aae6}}main.colorscheme-dark{color:#dadada;background-color:#212121}main.colorscheme-dark .content article strong{color:#dadada!important}main.colorscheme-dark .content .list ul li .title{color:#dadada}main.colorscheme-dark .content .list ul li .title:focus,main.colorscheme-dark .content .list ul li .title:hover{color:#42a5f5}main.colorscheme-dark .content .centered .about ul li a{color:#dadada}main.colorscheme-dark .content .centered .about ul li a:focus,main.colorscheme-dark .content .centered .about ul li a:hover{color:#42a5f5}@media (prefers-color-scheme:dark){main.colorscheme-auto{color:#dadada;background-color:#212121}main.colorscheme-auto .content article strong{color:#dadada!important}main.colorscheme-auto .content .list ul li .title{color:#dadada}main.colorscheme-auto .content .list ul li .title:focus,main.colorscheme-auto .content .list ul li .title:hover{color:#42a5f5}main.colorscheme-auto .content .centered .about ul li a{color:#dadada}main.colorscheme-auto .content .centered .about ul li a:focus,main.colorscheme-auto .content .centered .about ul li a:hover{color:#42a5f5}}main.colorscheme-dark .footer a{color:#42a5f5}@media (prefers-color-scheme:dark){main.colorscheme-auto .footer a{color:#42a5f5}}.container{max-width:1100px!important;width:80%}.colorscheme-dark .navigation .navigation-list .navigation-item .dropdown-content{background-color:#212121}.colorscheme-dark pre{color:#333}.wiki{width:100%!important;max-width:100%!important}.wiki #body-wrapper{width:100%}.wiki .post{max-width:100%!important}.wiki .wiki-cate-aside{font-weight:400;display:inline;float:left;visibility:visible;font-size:13px;width:240px;padding:0 20px 20px}.wiki .wiki-cate-aside ul{margin:0}.wiki .wiki-cate-aside a{font-size:13px;color:#555;font-weight:400}.wiki .wiki-cate-aside ol,.wiki .wiki-cate-aside ul{list-style:none;padding-left:20px}#articleWikiWrap{margin-left:240px}@media only screen and (max-width:900px){#articleWikiWrap{margin-left:0}#articleWikiAside{display:none}}code[class*=language-],pre[class*=language-]{color:#e3eaf2;background:0 0;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:#3c526d}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#3c526d}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#111b27}:not(pre)>code[class*=language-]{padding:.1em .3em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8da1b9}.token.punctuation{color:#e3eaf2}.token.delimiter.important,.token.selector .parent,.token.tag,.token.tag .token.punctuation{color:#6cc}.token.attr-name,.token.boolean,.token.boolean.important,.token.constant,.token.number,.token.selector .token.attribute{color:#e6d37a}.token.class-name,.token.key,.token.parameter,.token.property,.token.property-access,.token.variable{color:#6cb8e6}.token.attr-value,.token.color,.token.inserted,.token.selector .token.value,.token.string,.token.string .token.url-link{color:#91d076}.token.builtin,.token.keyword-array,.token.package,.token.regex{color:#f4adf4}.token.function,.token.selector .token.class,.token.selector .token.id{color:#c699e3}.token.atrule .token.rule,.token.combinator,.token.keyword,.token.operator,.token.pseudo-class,.token.pseudo-element,.token.selector,.token.unit{color:#e9ae7e}.token.deleted,.token.important{color:#cd6660}.token.keyword-this,.token.this{color:#6cb8e6}.token.bold,.token.important,.token.keyword-this,.token.this{font-weight:700}.token.delimiter.important{font-weight:inherit}.token.italic{font-style:italic}.token.entity{cursor:help}.language-markdown .token.title,.language-markdown .token.title .token.punctuation{color:#6cb8e6;font-weight:700}.language-markdown .token.blockquote.punctuation{color:#f4adf4}.language-markdown .token.code{color:#6cc}.language-markdown .token.hr.punctuation{color:#6cb8e6}.language-markdown .token.url .token.content{color:#91d076}.language-markdown .token.url-link{color:#e6d37a}.language-markdown .token.list.punctuation{color:#f4adf4}.language-json .token.operator,.language-markdown .token.table-header{color:#e3eaf2}.language-scss .token.variable{color:#6cc}.token.cr:before,.token.lf:before,.token.space:before,.token.tab:not(:empty):before{color:#8da1b9}div.code-toolbar>.toolbar a,div.code-toolbar>.toolbar button{color:#111b27;background:#6cb8e6}div.code-toolbar>.toolbar a:focus,div.code-toolbar>.toolbar a:hover,div.code-toolbar>.toolbar button:focus,div.code-toolbar>.toolbar button:hover{color:#111b27;background:rgba(108,184,230,.8549);text-decoration:none}div.code-toolbar>.toolbar span,div.code-toolbar>.toolbar span:focus,div.code-toolbar>.toolbar span:hover{color:#111b27;background:#8da1b9}.line-highlight{background:rgba(60,82,109,.37255);background:linear-gradient(90deg,rgba(60,82,109,.37255) 70%,rgba(60,82,109,.33333))}.line-highlight:before,.line-highlight[data-end]:after{background-color:#8da1b9;color:#111b27;box-shadow:0 1px #3c526d}pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(141,161,185,.09412)}.line-numbers .line-numbers-rows{border-right:1px solid #0b121b;background:rgba(11,18,27,.47843)}.line-numbers-rows>span:before{color:rgba(141,161,185,.8549)}.rainbow-braces .token.punctuation.brace-level-1,.rainbow-braces .token.punctuation.brace-level-5,.rainbow-braces .token.punctuation.brace-level-9{color:#e6d37a}.rainbow-braces .token.punctuation.brace-level-10,.rainbow-braces .token.punctuation.brace-level-2,.rainbow-braces .token.punctuation.brace-level-6{color:#f4adf4}.rainbow-braces .token.punctuation.brace-level-11,.rainbow-braces .token.punctuation.brace-level-3,.rainbow-braces .token.punctuation.brace-level-7{color:#6cb8e6}.rainbow-braces .token.punctuation.brace-level-12,.rainbow-braces .token.punctuation.brace-level-4,.rainbow-braces .token.punctuation.brace-level-8{color:#c699e3}pre.diff-highlight>code .token.deleted:not(.prefix),pre>code.diff-highlight .token.deleted:not(.prefix){background-color:rgba(205,102,96,.12157)}pre.diff-highlight>code .token.inserted:not(.prefix),pre>code.diff-highlight .token.inserted:not(.prefix){background-color:rgba(145,208,118,.12157)}.command-line-prompt{border-right:1px solid #0b121b}.command-line-prompt>span:before{color:rgba(141,161,185,.8549)}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.navigation[data-v-01c2c684]{height:6rem;width:100%}.navigation a[data-v-01c2c684],.navigation span[data-v-01c2c684]{display:inline;font-size:1.6rem;font-family:Lato,Helvetica,sans-serif;font-weight:700;line-height:6rem;color:#333}.navigation .fa[data-v-01c2c684]{color:#333;margin-left:.5rem;font-weight:700}.navigation a[data-v-01c2c684]:focus,.navigation a[data-v-01c2c684]:hover{color:#1565c0}.navigation .navigation-title[data-v-01c2c684]{letter-spacing:.1rem;text-transform:uppercase}.navigation .navigation-list[data-v-01c2c684]{float:right;list-style:none;margin-bottom:0;margin-top:0}@media only screen and (max-width:768px){.navigation .navigation-list[data-v-01c2c684]{position:absolute;top:6rem;right:0;z-index:5;visibility:hidden;opacity:0;padding:0;max-height:0;width:100%;background-color:#fafafa;border-top:2px solid #e0e0e0;border-bottom:2px solid #e0e0e0;transition:opacity .25s,max-height .15s linear}}.navigation .navigation-list .navigation-item[data-v-01c2c684]{float:left;margin:0;position:relative}@media only screen and (max-width:768px){.navigation .navigation-list .navigation-item[data-v-01c2c684]{float:none!important;text-align:center}.navigation .navigation-list .navigation-item a[data-v-01c2c684],.navigation .navigation-list .navigation-item span[data-v-01c2c684]{line-height:5rem}}.navigation .navigation-list .navigation-item a[data-v-01c2c684],.navigation .navigation-list .navigation-item span[data-v-01c2c684]{margin-left:1rem;margin-right:1rem}.navigation .navigation-list .navigation-item .dropdown-content[data-v-01c2c684]{display:none;position:absolute;background-color:#f9f9f9;min-width:100px;box-shadow:0 8px 16px 0 rgba(0,0,0,.2);padding:0;z-index:1;list-style-type:none}.navigation .navigation-list .dropdown:hover .dropdown-content[data-v-01c2c684]{display:block}.navigation .navigation-list .dropdown .navigation-link[data-v-01c2c684]{margin-right:0}@media only screen and (max-width:768px){.navigation .navigation-list .separator[data-v-01c2c684]{display:none}}@media only screen and (max-width:768px){.navigation .navigation-list .menu-separator[data-v-01c2c684]{border-top:2px solid #333;margin:0 8rem}.navigation .navigation-list .menu-separator span[data-v-01c2c684]{display:none}}.navigation #dark-mode-toggle[data-v-01c2c684]{margin:1.7rem 0;font-size:2.4rem;line-height:inherit}.navigation #menu-toggle[data-v-01c2c684]{display:none}@media only screen and (max-width:768px){.navigation #menu-toggle:checked+label>i[data-v-01c2c684]{color:#e0e0e0}.navigation #menu-toggle:checked+label+ul[data-v-01c2c684]{visibility:visible;opacity:1;max-height:100rem}}.navigation .menu-button[data-v-01c2c684]{display:none}@media only screen and (max-width:768px){.navigation .menu-button[data-v-01c2c684]{display:block;margin:1.8rem 0;font-size:2.4rem;font-weight:400}}.navigation i[data-v-01c2c684]{color:#333;cursor:pointer}.navigation i[data-v-01c2c684]:focus,.navigation i[data-v-01c2c684]:hover{color:#1565c0}main.colorscheme-dark .navigation a[data-v-01c2c684],main.colorscheme-dark .navigation span[data-v-01c2c684]{color:#dadada}main.colorscheme-dark .navigation a[data-v-01c2c684]:focus,main.colorscheme-dark .navigation a[data-v-01c2c684]:hover{color:#42a5f5}@media only screen and (max-width:768px){main.colorscheme-dark .navigation .navigation-list[data-v-01c2c684]{background-color:#212121;border-top:2px solid #424242;border-bottom:2px solid #424242}}@media only screen and (max-width:768px){main.colorscheme-dark .navigation .navigation-list .menu-separator[data-v-01c2c684]{border-top:2px solid #dadada}}@media only screen and (max-width:768px){main.colorscheme-dark .navigation #menu-toggle:checked+label>i[data-v-01c2c684]{color:#424242}}main.colorscheme-dark .navigation i[data-v-01c2c684]{color:#dadada}main.colorscheme-dark .navigation i[data-v-01c2c684]:focus,main.colorscheme-dark .navigation i[data-v-01c2c684]:hover{color:#42a5f5}@media (prefers-color-scheme:dark){main.colorscheme-auto .navigation a[data-v-01c2c684],main.colorscheme-auto .navigation span[data-v-01c2c684]{color:#dadada}main.colorscheme-auto .navigation a[data-v-01c2c684]:focus,main.colorscheme-auto .navigation a[data-v-01c2c684]:hover{color:#42a5f5}}@media only screen and (prefers-color-scheme:dark) and (max-width:768px){main.colorscheme-auto .navigation .navigation-list[data-v-01c2c684]{background-color:#212121;border-top:2px solid #424242;border-bottom:2px solid #424242}}@media only screen and (prefers-color-scheme:dark) and (max-width:768px){main.colorscheme-auto .navigation .navigation-list .menu-separator[data-v-01c2c684]{border-top:2px solid #dadada}}@media only screen and (prefers-color-scheme:dark) and (max-width:768px){main.colorscheme-auto .navigation #menu-toggle:checked+label>i[data-v-01c2c684]{color:#424242}}@media (prefers-color-scheme:dark){main.colorscheme-auto .navigation i[data-v-01c2c684]{color:#dadada}main.colorscheme-auto .navigation i[data-v-01c2c684]:focus,main.colorscheme-auto .navigation i[data-v-01c2c684]:hover{color:#42a5f5}}.out-link[data-v-01c2c684]{font-size:13px;margin-left:5px!important;margin-right:5px!important}.out-icon[data-v-01c2c684]{margin-left:3px;font-size:13px}.flex[data-v-28cd3b67]{display:flex}.justify-between[data-v-28cd3b67]{justify-content:space-between}</style><link rel="preload" href="/_nuxt/static/1637221111/posts/content/WebViewJavascriptBridge%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/state.js" as="script"><link rel="preload" href="/_nuxt/static/1637221111/posts/content/WebViewJavascriptBridge%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1637221111/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><main class="wrapper colorscheme-auto"><nav class="navigation" data-v-01c2c684><section class="container" data-v-01c2c684><a href="/" class="navigation-title nuxt-link-active" data-v-01c2c684>
      MistJ
    </a> <span id="dark-mode-toggle" class="float-right" data-v-01c2c684><fa icon="fa,adjust" style="cursor:pointer" data-v-01c2c684></fa></span> <input type="checkbox" id="menu-toggle" data-v-01c2c684> <label for="menu-toggle" class="menu-button float-right" data-v-01c2c684><fa icon="fa,bars" data-v-01c2c684></fa></label> <ul class="navigation-list" data-v-01c2c684><li class="navigation-item" data-v-01c2c684><a href="/posts/1" class="navigation-link" data-v-01c2c684> Posts
        </a> <!----> <!----></li><li class="navigation-item" data-v-01c2c684><a href="/categories" class="navigation-link" data-v-01c2c684> Categories
        </a> <!----> <!----></li><li class="navigation-item" data-v-01c2c684><a href="/tags" class="navigation-link" data-v-01c2c684> Tags
        </a> <!----> <!----></li><li class="navigation-item" data-v-01c2c684><a href="/series" class="navigation-link" data-v-01c2c684> Series
        </a> <!----> <!----></li><li class="navigation-item dropdown" data-v-01c2c684><a href="/wiki/" class="navigation-link" data-v-01c2c684> Wiki
        </a> <fa icon="fa,angle-down" data-v-01c2c684></fa> <ul class="dropdown-content" data-v-01c2c684><li data-v-01c2c684><div data-v-01c2c684><a href="/wiki/1" data-v-01c2c684> Timeline</a></div></li></ul></li><li class="navigation-item dropdown" data-v-01c2c684><a href="/tools/" class="navigation-link" data-v-01c2c684> Tools
        </a> <fa icon="fa,angle-down" data-v-01c2c684></fa> <ul class="dropdown-content" data-v-01c2c684><li data-v-01c2c684><div data-v-01c2c684><a href="/tools/json" data-v-01c2c684> JSON解析</a></div></li><li data-v-01c2c684><div data-v-01c2c684><a href="/tools/rsa" data-v-01c2c684> RSA测试</a></div></li><li data-v-01c2c684><div class="flex-align-center flex-y-center" data-v-01c2c684><fa icon="fa,link" class="out-icon" data-v-01c2c684></fa> <a href="https://wangchujiang.com/linux-command/" target="_Blank" class="out-link" data-v-01c2c684> linux命令</a></div></li></ul></li><li class="navigation-item" data-v-01c2c684><a href="/about" class="navigation-link" data-v-01c2c684> About
        </a> <!----> <!----></li> <li class="navigation-item separator" data-v-01c2c684><span data-v-01c2c684>|</span></li></ul></section></nav> <div class="content"><section class="container post" data-v-50af5a00><article data-v-50af5a00><header data-v-17b8de7f data-v-50af5a00><div class="post-title" data-v-17b8de7f><h1 class="title" data-v-17b8de7f>WebViewJavascriptBridge源码分析</h1></div> <div class="post-meta" data-v-17b8de7f><div class="date" data-v-17b8de7f><span class="posted-on" data-v-17b8de7f><fa icon="fa,calendar-alt" class="fa" data-v-17b8de7f></fa> <time datetime="2020-06-25 11:32:22" data-v-17b8de7f>
                May 14, 2020
              </time></span></div> <div class="categories" data-v-17b8de7f><fa icon="fa,folder" class="fa" data-v-17b8de7f></fa> <span data-v-17b8de7f><a href="/categories/iOS" data-v-17b8de7f> iOS </a> <!----></span></div> <div class="tags" data-v-17b8de7f><fa icon="fa,tag" class="fa" data-v-17b8de7f></fa> <span data-v-17b8de7f><a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90" data-v-17b8de7f> 源码分析 </a> <!----></span></div></div></header> <aside id="body-wrapper" data-v-50af5a00><div id="contents" class="body-content co-width-10" data-v-50af5a00><div class="nuxt-content" data-v-50af5a00 data-v-50af5a00><h2 id="js-相关的代码分析" data-v-50af5a00 data-v-50af5a00><a href="#js-%E7%9B%B8%E5%85%B3%E7%9A%84%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90" aria-hidden="true" tabindex="-1" data-v-50af5a00 data-v-50af5a00><span class="icon icon-link" data-v-50af5a00 data-v-50af5a00></span></a>js 相关的代码分析</h2>
<p data-v-50af5a00 data-v-50af5a00><a href="https://github.com/marcuswestin/WebViewJavascriptBridge" rel="nofollow noopener noreferrer" target="_blank" data-v-50af5a00 data-v-50af5a00>WebViewJavascriptBridge</a> 是 iOS 开发中常用的类库,用于前端和手机端交互。</p>
<p data-v-50af5a00 data-v-50af5a00>这里简单分析其源码，温故而知新。</p>
<h3 id="前端调用代码" data-v-50af5a00 data-v-50af5a00><a href="#%E5%89%8D%E7%AB%AF%E8%B0%83%E7%94%A8%E4%BB%A3%E7%A0%81" aria-hidden="true" tabindex="-1" data-v-50af5a00 data-v-50af5a00><span class="icon icon-link" data-v-50af5a00 data-v-50af5a00></span></a>前端调用代码</h3>

<p data-v-50af5a00 data-v-50af5a00>代码示例见<a href="https://github.com/marcuswestin/WebViewJavascriptBridge/blob/master/Example%20Apps/ExampleApp.html" rel="nofollow noopener noreferrer" target="_blank" data-v-50af5a00 data-v-50af5a00>链接</a></p>
<div class="nuxt-content-highlight" data-v-50af5a00 data-v-50af5a00><pre class="line-numbers language-js" data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00><span class="token keyword" data-v-50af5a00 data-v-50af5a00>function</span> <span class="token function" data-v-50af5a00 data-v-50af5a00>setupWebViewJavascriptBridge</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token parameter" data-v-50af5a00 data-v-50af5a00>callback</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
  <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token dom variable" data-v-50af5a00 data-v-50af5a00>window</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WebViewJavascriptBridge</span></span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>return</span> <span class="token function" data-v-50af5a00 data-v-50af5a00>callback</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WebViewJavascriptBridge</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
  <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token dom variable" data-v-50af5a00 data-v-50af5a00>window</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBCallbacks</span></span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>return</span> <span class="token dom variable" data-v-50af5a00 data-v-50af5a00>window</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBCallbacks</span></span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>push</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>callback<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
  <span class="token dom variable" data-v-50af5a00 data-v-50af5a00>window</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBCallbacks</span></span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>callback<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> <span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBIframe</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token dom variable" data-v-50af5a00 data-v-50af5a00>document</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>createElement</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token string" data-v-50af5a00 data-v-50af5a00>"iframe"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBIframe</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>style</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>display</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token string" data-v-50af5a00 data-v-50af5a00>"none"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBIframe</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>src</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token string" data-v-50af5a00 data-v-50af5a00>"https://__bridge_loaded__"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token dom variable" data-v-50af5a00 data-v-50af5a00>document</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>documentElement</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>appendChild</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBIframe</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token function" data-v-50af5a00 data-v-50af5a00>setTimeout</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token keyword" data-v-50af5a00 data-v-50af5a00>function</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token dom variable" data-v-50af5a00 data-v-50af5a00>document</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>documentElement</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>removeChild</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBIframe</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> <span class="token number" data-v-50af5a00 data-v-50af5a00>0</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>

<span class="token function" data-v-50af5a00 data-v-50af5a00>setupWebViewJavascriptBridge</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token keyword" data-v-50af5a00 data-v-50af5a00>function</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token parameter" data-v-50af5a00 data-v-50af5a00>bridge</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
  <span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> uniqueId <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token number" data-v-50af5a00 data-v-50af5a00>1</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  bridge<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>registerHandler</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token string" data-v-50af5a00 data-v-50af5a00>"testJavascriptHandler"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> <span class="token keyword" data-v-50af5a00 data-v-50af5a00>function</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>
    <span class="token parameter" data-v-50af5a00 data-v-50af5a00>data<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
    responseCallback</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token function" data-v-50af5a00 data-v-50af5a00>log</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token string" data-v-50af5a00 data-v-50af5a00>"ObjC called testJavascriptHandler with"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> data<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> responseData <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span> <span class="token string" data-v-50af5a00 data-v-50af5a00>"Javascript Says"</span><span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> <span class="token string" data-v-50af5a00 data-v-50af5a00>"Right back atcha!"</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token function" data-v-50af5a00 data-v-50af5a00>log</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token string" data-v-50af5a00 data-v-50af5a00>"JS responding with"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> responseData<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token function" data-v-50af5a00 data-v-50af5a00>responseCallback</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>responseData<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  bridge<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>callHandler</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token string" data-v-50af5a00 data-v-50af5a00>"testObjcCallback"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span> foo<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> <span class="token string" data-v-50af5a00 data-v-50af5a00>"bar"</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> <span class="token keyword" data-v-50af5a00 data-v-50af5a00>function</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token parameter" data-v-50af5a00 data-v-50af5a00>response</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token function" data-v-50af5a00 data-v-50af5a00>log</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token string" data-v-50af5a00 data-v-50af5a00>"JS got response"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> response<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
</code></pre></div>
<p data-v-50af5a00 data-v-50af5a00>前端需要引入上述代码,<code data-v-50af5a00 data-v-50af5a00>setupWebViewJavascriptBridge(...)</code>会执行以下操作:</p>
<ol data-v-50af5a00 data-v-50af5a00>
<li data-v-50af5a00 data-v-50af5a00>会判断<code data-v-50af5a00 data-v-50af5a00>window.WebViewJavascriptBridge</code>是否存在</li>
<li data-v-50af5a00 data-v-50af5a00>如果存在则直接作为参数回调给 function</li>
<li data-v-50af5a00 data-v-50af5a00>如果不存在:
<ul data-v-50af5a00 data-v-50af5a00>
<li data-v-50af5a00 data-v-50af5a00>将回调 function 存储到<code data-v-50af5a00 data-v-50af5a00>window.WVJBCallbacks</code></li>
<li data-v-50af5a00 data-v-50af5a00>在 dom 上添加 iframe,并且约定地址为<code data-v-50af5a00 data-v-50af5a00>https://__bridge_loaded__</code></li>
<li data-v-50af5a00 data-v-50af5a00>原生在 webview 的代理方法中监测到该地址的访问时,会拦截该请求,同时注入 js 代码。执行注入代码时会对<code data-v-50af5a00 data-v-50af5a00>WVJBCallbacks</code>进行遍历。</li>
</ul>
</li>
</ol>
<h3 id="webviewjavascriptbridge_jsm-代码分析" data-v-50af5a00 data-v-50af5a00><a href="#webviewjavascriptbridge_jsm-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90" aria-hidden="true" tabindex="-1" data-v-50af5a00 data-v-50af5a00><span class="icon icon-link" data-v-50af5a00 data-v-50af5a00></span></a>WebViewJavascriptBridge_JS.m 代码分析</h3>
<p data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00>WebViewJavascriptBridge_JS.m</code>中首先定义了一个宏:</p>
<div class="nuxt-content-highlight" data-v-50af5a00 data-v-50af5a00><pre class="line-numbers language-c" data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00><span class="token macro property" data-v-50af5a00 data-v-50af5a00><span class="token directive-hash" data-v-50af5a00 data-v-50af5a00>#</span><span class="token directive keyword" data-v-50af5a00 data-v-50af5a00>define</span> <span class="token macro-name function" data-v-50af5a00 data-v-50af5a00>__wvjb_js_func__</span><span class="token expression" data-v-50af5a00 data-v-50af5a00><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>x<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> #x</span></span>
</code></pre></div>
<p data-v-50af5a00 data-v-50af5a00>宏中包含了一个<code data-v-50af5a00 data-v-50af5a00>#</code>,这种写法专业点叫<code data-v-50af5a00 data-v-50af5a00>Stringize</code>, 作用是将宏转为字符串常量。例如:</p>
<div class="nuxt-content-highlight" data-v-50af5a00 data-v-50af5a00><pre class="line-numbers language-c" data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00><span class="token macro property" data-v-50af5a00 data-v-50af5a00><span class="token directive-hash" data-v-50af5a00 data-v-50af5a00>#</span><span class="token directive keyword" data-v-50af5a00 data-v-50af5a00>define</span> <span class="token macro-name function" data-v-50af5a00 data-v-50af5a00>toString</span><span class="token expression" data-v-50af5a00 data-v-50af5a00><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>size<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> #size</span></span>
<span class="token function" data-v-50af5a00 data-v-50af5a00>printf</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token function" data-v-50af5a00 data-v-50af5a00>toString</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token string" data-v-50af5a00 data-v-50af5a00>"good"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
<span class="token function" data-v-50af5a00 data-v-50af5a00>NSLog</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>@<span class="token function" data-v-50af5a00 data-v-50af5a00>toString</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token string" data-v-50af5a00 data-v-50af5a00>"good"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
</code></pre></div>
<p data-v-50af5a00 data-v-50af5a00>使用时虽然定义了很多行，其实字符串是在一行里。因此 js 代码开头和每个语句结尾都需要<code data-v-50af5a00 data-v-50af5a00>;</code> , 用来防止其他行代码的影响。</p>
<p data-v-50af5a00 data-v-50af5a00>此文件的 js 代码主要是对<code data-v-50af5a00 data-v-50af5a00>window.WebViewJavascriptBridge</code>进行初始化,以及一些消息逻辑处理。 下面是删减过的一些代码:</p>
<div class="nuxt-content-highlight" data-v-50af5a00 data-v-50af5a00><pre class="line-numbers language-js" data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00><span class="token dom variable" data-v-50af5a00 data-v-50af5a00>window</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WebViewJavascriptBridge</span></span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
  <span class="token comment" data-v-50af5a00 data-v-50af5a00>//绑定前端注册消息的方法</span>
  registerHandler<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> registerHandler<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
  <span class="token comment" data-v-50af5a00 data-v-50af5a00>//绑定前端主动调用app的方法</span>
  callHandler<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> callHandler<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
  <span class="token comment" data-v-50af5a00 data-v-50af5a00>//`dispatchMessagesWithTimeoutSafety`是否禁用alertbox以加速消息的执行</span>
  disableJavscriptAlertBoxSafetyTimeout<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> disableJavscriptAlertBoxSafetyTimeout<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
  <span class="token comment" data-v-50af5a00 data-v-50af5a00>//原生端通过此方法获取所有要执行的消息</span>
  _fetchQueue<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> _fetchQueue<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
  <span class="token comment" data-v-50af5a00 data-v-50af5a00>//原生端主动调用h5时,会触发此方法</span>
  _handleMessageFromObjC<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> _handleMessageFromObjC<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
<span class="token comment" data-v-50af5a00 data-v-50af5a00>// 存储app需要执行的消息数组,调用`_doSend`方法时,会在数组中插入一条数据</span>
<span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> sendMessageQueue <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
<span class="token comment" data-v-50af5a00 data-v-50af5a00>// 储存前端注册监听方法。`registerHandler`时会将监听方法进行存储</span>
<span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> messageHandlers <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
<span class="token comment" data-v-50af5a00 data-v-50af5a00>// h5主动去调用原生时,存储一个callbacks,根据以自定义的callbackId作为key。用于处理h5调用原生,然后接收原生返回数据的后的匹配。</span>
<span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> responseCallbacks <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
</code></pre></div>
<p data-v-50af5a00 data-v-50af5a00>需要注意的是 alert/prompt/confirm 会阻塞消息的执行,因此这里引入了<code data-v-50af5a00 data-v-50af5a00>disableJavscriptAlertBoxSafetyTimeout</code>来控制,但如果启用的话,可能影响安全性。</p>
<p data-v-50af5a00 data-v-50af5a00>下面看下查看核心的两个方法:</p>
<p data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00>_doSend</code>: h5 调用原生或者原生调用 h5,都会触发此方法。 <code data-v-50af5a00 data-v-50af5a00>responseCallback</code>只有在 h5 调用原生时才有值（h5 调用原生才需要回调;h5 接收到原生消息只需要将处理后的消息返回给原生,不需要 callback）。</p>
<div class="nuxt-content-highlight" data-v-50af5a00 data-v-50af5a00><pre class="line-numbers language-js" data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00><span class="token keyword" data-v-50af5a00 data-v-50af5a00>function</span> <span class="token function" data-v-50af5a00 data-v-50af5a00>_doSend</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token parameter" data-v-50af5a00 data-v-50af5a00>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> responseCallback</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
  <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>responseCallback<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> callbackId <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token string" data-v-50af5a00 data-v-50af5a00>"cb_"</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>+</span> uniqueId<span class="token operator" data-v-50af5a00 data-v-50af5a00>++</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>+</span> <span class="token string" data-v-50af5a00 data-v-50af5a00>"_"</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>+</span> <span class="token keyword" data-v-50af5a00 data-v-50af5a00>new</span> <span class="token class-name" data-v-50af5a00 data-v-50af5a00>Date</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>getTime</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    responseCallbacks<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>callbackId<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> responseCallback<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span><span class="token string" data-v-50af5a00 data-v-50af5a00>"callbackId"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> callbackId<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
  sendMessageQueue<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>push</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  messagingIframe<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>src</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token constant" data-v-50af5a00 data-v-50af5a00>CUSTOM_PROTOCOL_SCHEME</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>+</span> <span class="token string" data-v-50af5a00 data-v-50af5a00>"://"</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>+</span> <span class="token constant" data-v-50af5a00 data-v-50af5a00>QUEUE_HAS_MESSAGE</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
</code></pre></div>
<p data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00>_dispatchMessageFromObjC</code>: 处理原生发来的请求。</p>
<div class="nuxt-content-highlight" data-v-50af5a00 data-v-50af5a00><pre class="line-numbers language-js" data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00><span class="token keyword" data-v-50af5a00 data-v-50af5a00>function</span> <span class="token function" data-v-50af5a00 data-v-50af5a00>_dispatchMessageFromObjC</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token parameter" data-v-50af5a00 data-v-50af5a00>messageJSON</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
  <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>dispatchMessagesWithTimeoutSafety<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token function" data-v-50af5a00 data-v-50af5a00>setTimeout</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>_doDispatchMessageFromObjC<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span> <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>else</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token function" data-v-50af5a00 data-v-50af5a00>_doDispatchMessageFromObjC</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
  <span class="token keyword" data-v-50af5a00 data-v-50af5a00>function</span> <span class="token function" data-v-50af5a00 data-v-50af5a00>_doDispatchMessageFromObjC</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> message <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token known-class-name class-name" data-v-50af5a00 data-v-50af5a00>JSON</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>parse</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>messageJSON<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> messageHandler<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> responseCallback<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token comment" data-v-50af5a00 data-v-50af5a00>//不为空时,为h5调用原生，然后原生的消息返回</span>
    <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>responseId</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
      <span class="token comment" data-v-50af5a00 data-v-50af5a00>//根据消息id,找到h5注册的方法,并进行回调</span>
      responseCallback <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> responseCallbacks<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>responseId</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
      <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token operator" data-v-50af5a00 data-v-50af5a00>!</span>responseCallback<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
        <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>return</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
      <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
      <span class="token function" data-v-50af5a00 data-v-50af5a00>responseCallback</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>responseData</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
      <span class="token comment" data-v-50af5a00 data-v-50af5a00>//js主动调用原生的回调函数,只让他执行一次即可,不需要长久保存</span>
      <span class="token keyword" data-v-50af5a00 data-v-50af5a00>delete</span> responseCallbacks<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>responseId</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span> <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>else</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
      <span class="token comment" data-v-50af5a00 data-v-50af5a00>//此处的代码为原生调用h5的场景</span>
      <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>callbackId</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
        <span class="token comment" data-v-50af5a00 data-v-50af5a00>//原生如果需要h5的处理结果进行回调,则会传递过来callbackId</span>
        <span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> callbackResponseId <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>callbackId</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token comment" data-v-50af5a00 data-v-50af5a00>//定义h5处理结果返回原生的动作</span>
        <span class="token function-variable function" data-v-50af5a00 data-v-50af5a00>responseCallback</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token keyword" data-v-50af5a00 data-v-50af5a00>function</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token parameter" data-v-50af5a00 data-v-50af5a00>responseData</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
          <span class="token function" data-v-50af5a00 data-v-50af5a00>_doSend</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
            handlerName<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>handlerName</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
            responseId<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> callbackResponseId<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
            responseData<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> responseData<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
          <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
      <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
      <span class="token comment" data-v-50af5a00 data-v-50af5a00>//若h5对方法进行了注册`registerHandler`,那么这里可以获取到</span>
      <span class="token keyword" data-v-50af5a00 data-v-50af5a00>var</span> handler <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> messageHandlers<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>handlerName</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
      <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token operator" data-v-50af5a00 data-v-50af5a00>!</span>handler<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
        <span class="token console class-name" data-v-50af5a00 data-v-50af5a00>console</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token method function property-access" data-v-50af5a00 data-v-50af5a00>log</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>
          <span class="token string" data-v-50af5a00 data-v-50af5a00>"WebViewJavascriptBridge: WARNING: no handler for message from ObjC:"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span>
          message
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
      <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span> <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>else</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
        <span class="token comment" data-v-50af5a00 data-v-50af5a00>//对h5注册方法进行回调</span>
        <span class="token function" data-v-50af5a00 data-v-50af5a00>handler</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>data</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> responseCallback<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
      <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
    <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
  <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
</code></pre></div>
<h2 id="原生代码段" data-v-50af5a00 data-v-50af5a00><a href="#%E5%8E%9F%E7%94%9F%E4%BB%A3%E7%A0%81%E6%AE%B5" aria-hidden="true" tabindex="-1" data-v-50af5a00 data-v-50af5a00><span class="icon icon-link" data-v-50af5a00 data-v-50af5a00></span></a>原生代码段</h2>
<p data-v-50af5a00 data-v-50af5a00>原生代码的处理方法总体来说和 h5 的处理逻辑差不多。</p>
<h3 id="消息拦截" data-v-50af5a00 data-v-50af5a00><a href="#%E6%B6%88%E6%81%AF%E6%8B%A6%E6%88%AA" aria-hidden="true" tabindex="-1" data-v-50af5a00 data-v-50af5a00><span class="icon icon-link" data-v-50af5a00 data-v-50af5a00></span></a>消息拦截</h3>
<p data-v-50af5a00 data-v-50af5a00>处理的核心就是对自定义消息的拦截:</p>
<ul data-v-50af5a00 data-v-50af5a00>
<li data-v-50af5a00 data-v-50af5a00>当触发<code data-v-50af5a00 data-v-50af5a00>__bridge_loaded__</code>请求时,注入<code data-v-50af5a00 data-v-50af5a00>WebViewJavascriptBridge_JS.m</code>中的 js 代码</li>
<li data-v-50af5a00 data-v-50af5a00>当触发<code data-v-50af5a00 data-v-50af5a00>__wvjb_queue_message__</code>请求时,获取消息数组(<code data-v-50af5a00 data-v-50af5a00>WKFlushMessageQueue:</code>),并且依次执行消息(<code data-v-50af5a00 data-v-50af5a00>flushMessageQueue:</code>)</li>
</ul>
<div class="nuxt-content-highlight" data-v-50af5a00 data-v-50af5a00><pre class="line-numbers language-java" data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00><span class="token operator" data-v-50af5a00 data-v-50af5a00>-</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token keyword" data-v-50af5a00 data-v-50af5a00>void</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span>webView<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token class-name" data-v-50af5a00 data-v-50af5a00>WKWebView</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>*</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span>webView decidePolicyForNavigationAction<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token class-name" data-v-50af5a00 data-v-50af5a00>WKNavigationAction</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>*</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span>navigationAction
decisionHandler<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token keyword" data-v-50af5a00 data-v-50af5a00>void</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token operator" data-v-50af5a00 data-v-50af5a00>^</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token class-name" data-v-50af5a00 data-v-50af5a00>WKNavigationActionPolicy</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span>decisionHandler <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token keyword" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>webView <span class="token operator" data-v-50af5a00 data-v-50af5a00>!=</span> _webView<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span><span class="token keyword" data-v-50af5a00 data-v-50af5a00>return</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
    NSURL <span class="token operator" data-v-50af5a00 data-v-50af5a00>*</span>url <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> navigationAction<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span>request<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span>URL<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    __strong <span class="token function" data-v-50af5a00 data-v-50af5a00>typeof</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>_webViewDelegate<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> strongDelegate <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> _webViewDelegate<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token comment" data-v-50af5a00 data-v-50af5a00>//思路是拦截iframe的请求</span>
    <span class="token comment" data-v-50af5a00 data-v-50af5a00>// 判断是否自己内部定义的url,如__bridge_loaded__ 、__wvjb_queue_message__</span>
    <span class="token keyword" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>_base isWebViewJavascriptBridgeURL<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>url<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
        <span class="token keyword" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>_base isBridgeLoadedURL<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>url<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
            <span class="token comment" data-v-50af5a00 data-v-50af5a00>// 判断 __bridge_loaded__ 时,注入js。 __bridge_loaded__是前端手动注入的方法。 此时初始化桥js</span>
            <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>_base injectJavascriptFile<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span> <span class="token keyword" data-v-50af5a00 data-v-50af5a00>else</span> <span class="token keyword" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>_base isQueueMessageURL<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>url<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
            <span class="token comment" data-v-50af5a00 data-v-50af5a00>//当注入的方法执行`_doSend`时,触发 __wvjb_queue_message__</span>
            <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>self <span class="token class-name" data-v-50af5a00 data-v-50af5a00>WKFlushMessageQueue</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span> <span class="token keyword" data-v-50af5a00 data-v-50af5a00>else</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
            <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>_base logUnkownMessage<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>url<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
        <span class="token function" data-v-50af5a00 data-v-50af5a00>decisionHandler</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token class-name" data-v-50af5a00 data-v-50af5a00>WKNavigationActionPolicyCancel</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token keyword" data-v-50af5a00 data-v-50af5a00>return</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
    <span class="token keyword" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>strongDelegate <span class="token operator" data-v-50af5a00 data-v-50af5a00>&&</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>strongDelegate respondsToSelector<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span><span class="token annotation punctuation" data-v-50af5a00 data-v-50af5a00>@selector</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>webView<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>decidePolicyForNavigationAction<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>decisionHandler<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>_webViewDelegate webView<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>webView decidePolicyForNavigationAction<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>navigationAction decisionHandler<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>decisionHandler<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span> <span class="token keyword" data-v-50af5a00 data-v-50af5a00>else</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
        <span class="token function" data-v-50af5a00 data-v-50af5a00>decisionHandler</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token class-name" data-v-50af5a00 data-v-50af5a00>WKNavigationActionPolicyAllow</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
</code></pre></div>
<h3 id="消息执行" data-v-50af5a00 data-v-50af5a00><a href="#%E6%B6%88%E6%81%AF%E6%89%A7%E8%A1%8C" aria-hidden="true" tabindex="-1" data-v-50af5a00 data-v-50af5a00><span class="icon icon-link" data-v-50af5a00 data-v-50af5a00></span></a>消息执行</h3>
<p data-v-50af5a00 data-v-50af5a00>原生调用 js 就比较简单了,核心代码见<code data-v-50af5a00 data-v-50af5a00>flushMessageQueue:</code>,此处执行的消息可能有两种类型：一种是原生调用 h5,另一种是 h5 调用原生后的结果的回调。</p>
<div class="nuxt-content-highlight" data-v-50af5a00 data-v-50af5a00><pre class="line-numbers language-js" data-v-50af5a00 data-v-50af5a00><code data-v-50af5a00 data-v-50af5a00><span class="token operator" data-v-50af5a00 data-v-50af5a00>-</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token keyword" data-v-50af5a00 data-v-50af5a00>void</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span>flushMessageQueue<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>NSString</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>*</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span>messageQueueString <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
    <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>messageQueueString <span class="token operator" data-v-50af5a00 data-v-50af5a00>==</span> nil <span class="token operator" data-v-50af5a00 data-v-50af5a00>||</span> messageQueueString<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>length</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>==</span> <span class="token number" data-v-50af5a00 data-v-50af5a00>0</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
        <span class="token function" data-v-50af5a00 data-v-50af5a00><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>NSLog</span></span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"WebViewJavascriptBridge: WARNING: ObjC got nil while fetching the message queue JSON from webview. This can happen if the WebViewJavascriptBridge JS is not currently present in the webview, e.g if the webview just loaded a new page."</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>return</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>

    id messages <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>self _deserializeMessageJSON<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>messageQueueString<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
    <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>for</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBMessage</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>*</span>message <span class="token keyword" data-v-50af5a00 data-v-50af5a00>in</span> messages<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
        <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token operator" data-v-50af5a00 data-v-50af5a00>!</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>message isKindOfClass<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBMessage</span> <span class="token keyword" data-v-50af5a00 data-v-50af5a00>class</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
            <span class="token function" data-v-50af5a00 data-v-50af5a00><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>NSLog</span></span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"WebViewJavascriptBridge: WARNING: Invalid %@ received: %@"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>message <span class="token keyword" data-v-50af5a00 data-v-50af5a00>class</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
            <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>continue</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>self _log<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"RCVD"</span> json<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>

        <span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>NSString</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>*</span>responseId <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"responseId"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>responseId<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
            <span class="token comment" data-v-50af5a00 data-v-50af5a00>// responseId不为空,说明是原生调用h5的回调的响应。</span>
            <span class="token comment" data-v-50af5a00 data-v-50af5a00>//直接回调block闭包。 原生调用h5时,会将block存储到中,此处用到就取出来</span>
            <span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBResponseCallback</span> responseCallback <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> _responseCallbacks<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>responseId<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
            <span class="token function" data-v-50af5a00 data-v-50af5a00>responseCallback</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"responseData"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
            <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>self<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>responseCallbacks</span> removeObjectForKey<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>responseId<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span> <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>else</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
            <span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBResponseCallback</span> responseCallback <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token constant" data-v-50af5a00 data-v-50af5a00>NULL</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
            <span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>NSString</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>*</span>callbackId <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"callbackId"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
            <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>callbackId<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
                responseCallback <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>^</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>id responseData<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
                    <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>responseData <span class="token operator" data-v-50af5a00 data-v-50af5a00>==</span> nil<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
                        responseData <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>NSNull</span> <span class="token keyword null nil" data-v-50af5a00 data-v-50af5a00>null</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
                    <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
                    <span class="token comment" data-v-50af5a00 data-v-50af5a00>// 闭包触发后,将数据返回给h5</span>
                    <span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBMessage</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>*</span>msg <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> @<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"responseId"</span><span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> callbackId<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> @<span class="token string" data-v-50af5a00 data-v-50af5a00>"responseData"</span><span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span> responseData<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
                    <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>self _queueMessage<span class="token operator" data-v-50af5a00 data-v-50af5a00>:</span>msg<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
                <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
            <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span> <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>else</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
                responseCallback <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> <span class="token operator" data-v-50af5a00 data-v-50af5a00>^</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>id ignoreResponseData<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
                    <span class="token comment" data-v-50af5a00 data-v-50af5a00>// Do nothing</span>
                <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
            <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
            <span class="token comment" data-v-50af5a00 data-v-50af5a00>//因为是原生调用h5,因此对应的方法原生应该有注册,并保存到了messageHandlers这里。</span>
            <span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>WVJBHandler</span> handler <span class="token operator" data-v-50af5a00 data-v-50af5a00>=</span> self<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>.</span><span class="token property-access" data-v-50af5a00 data-v-50af5a00>messageHandlers</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"handlerName"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
            <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>if</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span><span class="token operator" data-v-50af5a00 data-v-50af5a00>!</span>handler<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span> <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>{</span>
                <span class="token function" data-v-50af5a00 data-v-50af5a00><span class="token maybe-class-name" data-v-50af5a00 data-v-50af5a00>NSLog</span></span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"WVJBNoHandlerException, No handler for message from JS: %@"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
                <span class="token keyword control-flow" data-v-50af5a00 data-v-50af5a00>continue</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
            <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
            <span class="token comment" data-v-50af5a00 data-v-50af5a00>//触发闭包响应</span>
            <span class="token function" data-v-50af5a00 data-v-50af5a00>handler</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>(</span>message<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>[</span>@<span class="token string" data-v-50af5a00 data-v-50af5a00>"data"</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>]</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>,</span> responseCallback<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>)</span><span class="token punctuation" data-v-50af5a00 data-v-50af5a00>;</span>
        <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
    <span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
<span class="token punctuation" data-v-50af5a00 data-v-50af5a00>}</span>
</code></pre></div>
<h2 id="总结" data-v-50af5a00 data-v-50af5a00><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" tabindex="-1" data-v-50af5a00 data-v-50af5a00><span class="icon icon-link" data-v-50af5a00 data-v-50af5a00></span></a>总结</h2>
<p data-v-50af5a00 data-v-50af5a00>整体来说 jsbridge 的代码比较清晰优雅的,很多细节值的学习。</p></div> <div class="flex justify-between" data-v-28cd3b67 data-v-50af5a00><a href="/posts/content/go-learn-3" class="font-bold text-primary hover:underline" data-v-28cd3b67>
    上一篇Go笔记(三)：测试、反射、json解析
  </a> <a href="/posts/content/fastlane+Jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2" class="font-bold hover:underline" data-v-28cd3b67>
    下一篇fastlane+Jenkins自动化部署iOS项目
  </a></div></div> <div class="sidebar co-width-2" style="padding-left:12px;display:none" data-v-50af5a00><div class="toc-fixed" data-v-50af5a00><nav id="TableOfContents" data-v-50af5a00><ul data-v-50af5a00><li class="py-2" style="text-indent:8px" data-v-50af5a00><a href="#js-相关的代码分析" data-v-50af5a00> js 相关的代码分析 </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-50af5a00><a href="#前端调用代码" data-v-50af5a00> 前端调用代码 </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-50af5a00><a href="#webviewjavascriptbridge_jsm-代码分析" data-v-50af5a00> WebViewJavascriptBridge_JS.m 代码分析 </a></li><li class="py-2" style="text-indent:8px" data-v-50af5a00><a href="#原生代码段" data-v-50af5a00> 原生代码段 </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-50af5a00><a href="#消息拦截" data-v-50af5a00> 消息拦截 </a></li><li class="ml-2 pb-2" style="text-indent:16px" data-v-50af5a00><a href="#消息执行" data-v-50af5a00> 消息执行 </a></li><li class="py-2" style="text-indent:8px" data-v-50af5a00><a href="#总结" data-v-50af5a00> 总结 </a></li></ul></nav> <a href="#" id="tap-to-top" data-v-50af5a00><fa icon="fa,arrow-up" data-v-50af5a00></fa></a></div></div></aside></article></section></div> <footer class="footer" data-v-2a7d065f><section class="container" data-v-2a7d065f>
    © 2020 MistJ · Powered by <a href data-v-2a7d065f>Vue</a> &
    <a href="https://github.com/tyrad/hugo-coder/" data-v-2a7d065f>Coder</a>.
  </section></footer></main></div></div><script defer src="/_nuxt/static/1637221111/posts/content/WebViewJavascriptBridge%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/state.js"></script><script src="/_nuxt/js/runtime.1637221086066.js" defer></script><script src="/_nuxt/js/pages/index.1637221086066.js" defer></script><script src="/_nuxt/js/pages/index/posts/content/_slug.1637221086066.js" defer></script><script src="/_nuxt/js/commons/app.1637221086066.js" defer></script><script src="/_nuxt/js/vendors/app.1637221086066.js" defer></script><script src="/_nuxt/js/app.1637221086066.js" defer></script>
  </body>
</html>
